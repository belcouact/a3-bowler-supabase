import{c as F,r as d,O as e,d as $,ac as O,ad as J,W as G,Y as Z,a3 as L,ae as B,S as U,X as q}from"./index-OJLlwzTi.js";import{Z as K,a as _}from"./zoom-out-DZs2veMC.js";import{T as V}from"./trash-2-ChIKrDpC.js";import{A as Q}from"./alert-circle-CgH8a-Y2.js";/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=F("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]),j=200,M=80,z=[{name:"White",value:"#ffffff",border:"#e2e8f0"},{name:"Blue",value:"#eff6ff",border:"#bfdbfe"},{name:"Green",value:"#f0fdf4",border:"#bbf7d0"},{name:"Yellow",value:"#fefce8",border:"#fef08a"},{name:"Red",value:"#fef2f2",border:"#fecaca"},{name:"Purple",value:"#faf5ff",border:"#e9d5ff"}],te=({node:s,onUpdate:y,onAdd:u,onDelete:r,onMouseDown:p})=>{var N;const v=d.useRef(null),g=d.useRef(null),[k,S]=d.useState(!1),A=d.useRef(s);d.useLayoutEffect(()=>{A.current=s}),d.useLayoutEffect(()=>{if(v.current&&!s.customHeight){v.current.style.height="auto";const i=v.current.scrollHeight;v.current.style.height=i+"px"}},[s.text,s.customHeight]),d.useEffect(()=>{if(!g.current)return;const i=new ResizeObserver(C=>{for(const R of C)requestAnimationFrame(()=>{const m=R.target,f=A.current,x=m.offsetWidth,b=m.offsetHeight;(Math.abs((f.width||j)-x)>5||Math.abs((f.height||M)-b)>5)&&y(f.id,{width:x,height:b})})});return i.observe(g.current),()=>i.disconnect()},[y]);const w=i=>{var t,n;i.stopPropagation(),i.preventDefault();const C=i.clientX,R=i.clientY,m=((t=g.current)==null?void 0:t.offsetWidth)||j,f=((n=g.current)==null?void 0:n.offsetHeight)||M,x=a=>{const o=a.clientX-C,l=a.clientY-R,c=Math.max(100,m+o),h=Math.max(50,f+l);y(s.id,{customWidth:c,customHeight:h,width:c,height:h})},b=()=>{window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",b)};window.addEventListener("mousemove",x),window.addEventListener("mouseup",b)};return e.jsxs("div",{ref:g,style:{transform:`translate(${s.x}px, ${s.y}px)`,width:s.customWidth||j,height:s.customHeight,backgroundColor:s.color||(s.type==="root"?"#eff6ff":"#ffffff"),borderColor:s.color?(N=z.find(i=>i.value===s.color))==null?void 0:N.border:void 0},className:$("absolute flex flex-col p-3 rounded-lg shadow-sm border transition-shadow group select-none",!s.color&&(s.type==="root"?"bg-blue-50 border-blue-200":"bg-white border-slate-200 hover:border-blue-300")),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 cursor-grab active:cursor-grabbing border-b border-transparent group-hover:border-slate-100 pb-1 relative",onMouseDown:i=>p(i,s.id),children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-wider text-slate-400",children:s.type==="root"?"PROBLEM":"WHY?"}),e.jsxs("div",{className:"flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity items-center",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:i=>{i.stopPropagation(),S(!k)},className:"p-1 hover:bg-slate-100 text-slate-400 hover:text-slate-600 rounded",title:"Change Color",children:e.jsx(ee,{className:"w-3 h-3"})}),k&&e.jsx("div",{className:"absolute top-full right-0 mt-1 p-2 bg-white rounded-lg shadow-xl border border-gray-200 flex gap-1 z-[70] min-w-[140px] flex-wrap",onMouseDown:i=>i.stopPropagation(),children:z.map(i=>e.jsx("button",{className:"w-6 h-6 rounded-full border border-gray-200 hover:scale-110 transition-transform",style:{backgroundColor:i.value},onClick:C=>{C.stopPropagation(),y(s.id,{color:i.value}),S(!1)},title:i.name},i.name))})]}),s.type!=="root"&&e.jsx("button",{onClick:()=>r(s.id),className:"p-1 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded",title:"Delete branch",children:e.jsx(V,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>u(s.id,"right"),className:"p-1 hover:bg-blue-50 text-slate-400 hover:text-blue-500 rounded",title:"Add next Why (Right)",children:e.jsx(O,{className:"w-3 h-3"})})]})]}),e.jsx("textarea",{ref:v,value:s.text,onChange:i=>y(s.id,{text:i.target.value}),style:{height:s.customHeight?"100%":void 0,resize:"none"},className:$("w-full text-sm bg-transparent border-none focus:ring-0 p-0 text-slate-700 font-medium overflow-hidden",s.customHeight?"flex-1":""),rows:1,placeholder:s.type==="root"?"Describe the problem...":"Ask why...",onMouseDown:i=>i.stopPropagation()}),e.jsx("div",{className:"absolute bottom-0 right-0 w-4 h-4 cursor-se-resize flex items-center justify-center opacity-0 group-hover:opacity-100 z-20",onMouseDown:w,title:"Resize",children:e.jsx("div",{className:"w-2 h-2 border-r-2 border-b-2 border-slate-300"})}),e.jsx("button",{className:"absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-white border border-slate-200 rounded-full p-1 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-blue-50 text-slate-400 hover:text-blue-500 z-10",onClick:()=>u(s.id,"bottom"),title:"Add Why below",children:e.jsx(O,{className:"w-3 h-3"})})]})},se=({initialNodes:s,onChange:y})=>{const[u,r]=d.useState(s&&s.length>0?s:[{id:"root",text:"Define the Problem",x:50,y:250,width:j,height:M,parentId:null,type:"root"}]),[p,v]=d.useState(1),[g,k]=d.useState(null),[S,A]=d.useState({x:0,y:0}),w=d.useRef(null),N=d.useRef(y);d.useEffect(()=>{N.current=y},[y]),d.useEffect(()=>{N.current&&N.current(u)},[u]),d.useEffect(()=>{s&&s.length>0&&g===null&&r(t=>t===s||JSON.stringify(t)===JSON.stringify(s)?t:s)},[s,g]);const i=(t,n)=>{t.stopPropagation();const a=u.find(h=>h.id===n);if(!a||!w.current)return;const o=w.current.getBoundingClientRect(),l=(t.clientX-o.left)/p,c=(t.clientY-o.top)/p;A({x:l-a.x,y:c-a.y}),k(n)},C=t=>{if(!g||!w.current)return;const n=w.current.getBoundingClientRect(),a=(t.clientX-n.left)/p,o=(t.clientY-n.top)/p;r(u.map(l=>l.id===g?{...l,x:a-S.x,y:o-S.y}:l))},R=()=>{k(null)},m=(t,n)=>{const a=u.find(l=>l.id===t);if(!a)return;const o={id:J(),text:"Why?",x:0,y:0,width:j,height:M,parentId:t,type:"child"};if(n==="bottom"){o.x=a.x,o.y=a.y+(a.height||M)+50;const l=u.filter(c=>c.parentId===t&&c.y>a.y+(a.height||M)/2);if(l.length>0){const c=Math.max(...l.map(h=>h.x));o.x=c+(j+20)}}else{o.x=a.x+(a.width||j)+50,o.y=a.y;const l=u.filter(c=>c.parentId===t&&c.x>a.x+(a.width||j)/2);if(l.length>0){const c=Math.max(...l.map(h=>h.y));o.y=c+(M+20)}}r([...u,o])},f=t=>{const n=o=>{const l=u.filter(h=>h.parentId===o);let c=l.map(h=>h.id);return l.forEach(h=>{c=[...c,...n(h.id)]}),c},a=[t,...n(t)];r(u.filter(o=>!a.includes(o.id)))},x=d.useCallback((t,n)=>{r(a=>a.map(o=>o.id===t?{...o,...n}:o))},[]),b=()=>u.map(t=>{if(!t.parentId)return null;const n=u.find(T=>T.id===t.parentId);if(!n)return null;const a=n.width||j,o=n.height||M,l=t.width||j,c=t.height||M;let h,P,I,E,D,W,H,Y;t.y>=n.y+o-10?(h=n.x+a/2,P=n.y+o,I=t.x+l/2,E=t.y,D=h,W=P+(E-P)/2,H=I,Y=E-(E-P)/2):(h=n.x+a,P=n.y+o/2,I=t.x,E=t.y+c/2,D=h+(I-h)/2,W=P,H=I-(I-h)/2,Y=E);const X=`M ${h} ${P} C ${D} ${W}, ${H} ${Y}, ${I} ${E}`;return e.jsx("path",{d:X,stroke:"#475569",strokeWidth:"3",fill:"none"},`${n.id}-${t.id}`)});return e.jsx("div",{className:"flex flex-col space-y-2",children:e.jsxs("div",{ref:w,className:"w-full h-[600px] bg-slate-50 relative overflow-hidden border border-slate-200 rounded-lg cursor-grab active:cursor-grabbing resize-y",onMouseMove:C,onMouseUp:R,onMouseLeave:R,children:[e.jsxs("div",{className:"absolute top-4 right-4 z-20 flex items-center bg-white/80 rounded-md p-1 shadow backdrop-blur-sm border border-slate-200",children:[e.jsx("button",{onClick:()=>v(Math.max(.5,p-.1)),className:"p-1 hover:bg-gray-100 rounded",title:"Zoom Out",children:e.jsx(K,{className:"w-4 h-4 text-gray-600"})}),e.jsxs("span",{className:"text-xs text-gray-500 w-12 text-center select-none",children:[Math.round(p*100),"%"]}),e.jsx("button",{onClick:()=>v(Math.min(2,p+.1)),className:"p-1 hover:bg-gray-100 rounded",title:"Zoom In",children:e.jsx(_,{className:"w-4 h-4 text-gray-600"})})]}),e.jsxs("div",{style:{transform:`scale(${p})`,transformOrigin:"0 0",width:"100%",height:"100%",position:"relative"},children:[e.jsx("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{overflow:"visible",zIndex:0},width:"100%",height:"100%",children:b()}),e.jsx("div",{className:"relative",style:{zIndex:10},children:u.map(t=>e.jsx(te,{node:t,onUpdate:x,onAdd:m,onDelete:f,onMouseDown:i},t.id))})]})]})})},ie=()=>{const{id:s}=G(),{a3Cases:y,updateA3Case:u}=Z(),r=y.find(m=>m.id===s),[p,v]=d.useState(""),[g,k]=d.useState(!1),[S,A]=d.useState(null),[w,N]=d.useState(null);d.useEffect(()=>{r&&r.rootCause!==p&&v(r.rootCause||"")},[r]),d.useEffect(()=>{if(!(r!=null&&r.mindMapNodes))return;const m=r.mindMapNodes;if(m.length===0)return;const f=m.filter(t=>!t.parentId);let x="";const b=(t,n)=>{const a=m.filter(o=>o.parentId===t);a.sort((o,l)=>o.y-l.y);for(const o of a){const l="  ".repeat(n);x+=`${l}- ${o.text}
`,b(o.id,n+1)}};f.sort((t,n)=>t.y-n.y);for(const t of f)x+=`${t.text}
`,b(t.id,1);x!==r.mindMapText&&u({...r,mindMapText:x})},[r==null?void 0:r.mindMapNodes,u,r==null?void 0:r.id]);const i=d.useCallback(m=>{if(!r)return;const f=JSON.stringify(r.mindMapNodes),x=JSON.stringify(m);f!==x&&u({...r,mindMapNodes:m})},[r,u]),C=m=>{const f=m.target.value;v(f),r&&u({...r,rootCause:f})},R=async()=>{var b,t,n;if(!r)return;const m=r.problemStatement||"",f=r.dataAnalysisObservations||"",x=p||r.rootCause||"";if(!(!m.trim()||!x.trim())){k(!0),N(null),A(null);try{const a=[{role:"system",content:`You are an expert continuous improvement and operations coach.

You will receive:
- A3 Problem Statement
- Key observations from data analysis
- Identified root cause

Your task is to propose practical improvement actions that address the root cause.

Respond in English, even if the user's inputs are in another language.

Structure the answer with markdown headings:
## Short-term Actions
## Long-term Actions

Under each heading, list concise, actionable bullet points. Focus on actions that are realistic in a manufacturing or service environment.`},{role:"user",content:`Problem Statement:
${m}

Key Observations from Data:
${f}

Identified Root Cause:
${x}`}],o=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"deepseek",messages:a,stream:!1})});if(!o.ok)throw new Error("Failed to generate improvement actions");let c=((n=(t=(b=(await o.json()).choices)==null?void 0:b[0])==null?void 0:t.message)==null?void 0:n.content)||"";c=c.replace(/^```[\s\S]*?```/g,"").trim(),A(c)}catch{N("Failed to generate improvement actions. Please try again.")}finally{k(!1)}}};return r?e.jsxs("div",{className:"space-y-6 w-full flex flex-col",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"5 Whys Analysis"}),e.jsx("p",{className:"text-gray-500 mb-4",children:'Interactive Root Cause Analysis. Start with the problem and drill down by adding "Why" nodes.'})]}),e.jsx("div",{className:"flex flex-col",children:e.jsx(se,{initialNodes:r.mindMapNodes,onChange:i})}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{htmlFor:"rootCause",className:"block text-sm font-medium text-gray-700",children:"Identified Root Cause"}),e.jsx("button",{type:"button",onClick:R,disabled:g||!r.problemStatement||!(p||r.rootCause),className:"inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-indigo-700 bg-indigo-50 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:g?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"animate-spin -ml-0.5 mr-2 h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"Generating actions..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"-ml-0.5 mr-0 sm:mr-2 h-3 w-3"}),e.jsx("span",{className:"hidden sm:inline",children:"AI Improvement Actions"})]})})]}),e.jsx("textarea",{id:"rootCause",rows:8,className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border",placeholder:"Summarize the root cause identified from the analysis...",value:p,onChange:C}),w&&e.jsx("div",{className:"mt-3 rounded-md bg-red-50 p-3",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Q,{className:"h-4 w-4 text-red-400","aria-hidden":"true"})}),e.jsx("div",{className:"ml-2 text-sm text-red-700",children:w})]})}),S&&e.jsxs("div",{className:"mt-4 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-blue-50 px-4 py-2 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xs font-bold text-blue-900 flex items-center",children:[e.jsx(U,{className:"h-4 w-4 mr-2 text-blue-600"}),"AI Improvement Actions"]}),e.jsx("button",{type:"button",className:"text-gray-400 hover:text-gray-500",onClick:()=>A(null),children:e.jsx(q,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"p-4",children:e.jsx("div",{className:"prose prose-sm max-w-none text-gray-700 bg-gray-50 p-3 rounded-md text-sm whitespace-pre-wrap",children:S})})]})]})]}):e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(L,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("p",{className:"mt-3 text-base font-medium text-gray-700",children:"Loading application data..."})]})})};export{ie as default};
