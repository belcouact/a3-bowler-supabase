import{V as D,Y as H,r as i,O as e,a3 as k}from"./index-CVcs9xOb.js";import{M as L}from"./MarkdownRenderer-ChbcGXo0.js";import{S as P}from"./send-BIYzMolN.js";import{A as J}from"./alert-triangle-BXsyeP0A.js";const M={},q=()=>{const{id:I}=D(),{a3Cases:C,bowlers:E,selectedModel:S}=H(),t=C.find(s=>s.id===I),[c,d]=i.useState([]),[h,b]=i.useState(""),[u,w]=i.useState(!1),f=i.useRef(null);i.useEffect(()=>{f.current&&f.current.scrollIntoView({behavior:"smooth"})},[c]),i.useEffect(()=>{if(!t)return;const s=t.id,o=M[s];if(o&&o.length>0){d(o);return}const r={role:"assistant",content:`I am your AI coach focusing specifically on this A3: **${t.title||"this A3"}**.

I already know the problem statement, analysis, and plan that you have entered.
Ask me anything to help you think through root causes, risks, action plans, or follow-up.

Examples:
- "What are the top risks or uncertainties in this A3?"
- "How can we strengthen the action plan using industry best practices?"
- "What should we watch in the data to confirm this A3 is working?"`};d([r])},[t]),i.useEffect(()=>{t&&(M[t.id]=c)},[t,c]);const T=s=>{if(!t)return"";const o=t.linkedMetricIds||[],l=[];E.forEach(n=>{(n.metrics||[]).forEach(a=>{o.includes(a.id)&&l.push({bowlerName:n.name,bowlerGroup:n.group||"Ungrouped",metric:{id:a.id,name:a.name,definition:a.definition,owner:a.owner,scope:a.scope,attribute:a.attribute,targetMeetingRule:a.targetMeetingRule,monthlyData:a.monthlyData}})})});const r={...t};delete r.mindMapNodes,delete r.dataAnalysisImages,delete r.resultImages,delete r.dataAnalysisCanvasHeight,delete r.resultCanvasHeight;const m=s.filter(n=>n.role==="user"||n.role==="assistant").map(n=>({role:n.role,content:n.content}));return JSON.stringify({a3Case:r,linkedMetrics:l,conversation:m})},R=async s=>{var r,m,n,g,a,v;if(!s.trim()||u||!t)return;const o={role:"user",content:s},l=[...c,o];d(l),b(""),w(!0);try{const p=l.filter(y=>y.role!=="system"),O=[{role:"system",content:`You are an AI coach helping the owner of a single A3 case.

Here is the JSON context for this A3, including any linked metrics:
${T(p)}

Your job is to answer any questions the user has about this A3 and its related metrics.
Examples include: clarifying the problem, commenting on data and analysis, suggesting root-cause checks, highlighting risks or uncertainties, advising on action plan design and prioritization, or discussing follow-up and sustainment.

Keep your answers specific, practical, and focused on this A3 only.`},...p],x=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:S,messages:O,stream:!1})});if(!x.ok)throw new Error(`API Error: ${x.statusText}`);const A=await x.json(),$=((n=(m=(r=A.choices)==null?void 0:r[0])==null?void 0:m.message)==null?void 0:n.content)||((v=(a=(g=A.choices)==null?void 0:g[0])==null?void 0:a.delta)==null?void 0:v.content)||"Sorry, I couldn't generate a response.";d(y=>[...y,{role:"assistant",content:$}])}catch{d(N=>[...N,{role:"assistant",content:"Sorry, there was an error communicating with the AI coach. Please try again later."}])}finally{w(!1)}},j=()=>{h.trim()&&R(h)};return t?e.jsxs("div",{className:"flex flex-col h-full min-h-[480px] space-y-4",children:[e.jsxs("div",{className:"flex-1 flex flex-col rounded-lg border border-gray-200 bg-gray-50 overflow-hidden",children:[e.jsxs("div",{className:"flex-1 p-4 overflow-y-auto",children:[c.map((s,o)=>e.jsx("div",{className:`mb-4 flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-lg px-4 py-3 shadow-sm ${s.role==="user"?"bg-indigo-600 text-white rounded-br-none":"bg-white text-gray-800 border border-gray-200 rounded-bl-none"}`,children:s.role==="user"?e.jsx("div",{className:"whitespace-pre-wrap text-sm",children:s.content}):e.jsx("div",{className:"text-sm",children:e.jsx(L,{content:s.content})})})},o)),u&&e.jsx("div",{className:"flex justify-start mb-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm rounded-bl-none flex items-center",children:[e.jsx(k,{className:"w-4 h-4 animate-spin text-indigo-600 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Thinking..."})]})}),e.jsx("div",{ref:f})]}),e.jsx("div",{className:"border-t border-gray-200 bg-white px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"text",className:"flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border",placeholder:"Ask the coach about this A3...",value:h,onChange:s=>b(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),j())},disabled:u}),e.jsx("button",{type:"button",onClick:j,disabled:u||!h.trim(),className:"inline-flex items-center p-2 border border-transparent rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-300",children:e.jsx(P,{className:"h-5 w-5"})})]})})]}),!t.problemStatement&&e.jsxs("div",{className:"mt-1 rounded-md bg-yellow-50 border border-yellow-200 px-3 py-2 text-xs text-yellow-800 flex items-start",children:[e.jsx(J,{className:"h-4 w-4 mr-2 mt-0.5"}),e.jsx("p",{children:"Tip: The coach works best when the problem statement, analysis, and action plan are filled in."})]})]}):e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(k,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("p",{className:"mt-3 text-base font-medium text-gray-700",children:"Loading A3 data for coaching..."})]})})};export{q as default};
