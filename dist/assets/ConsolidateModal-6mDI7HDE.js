import{r as v,aF as T,Y as E,Z as M,O as s,X as z,a3 as D,aH as B,ad as P}from"./index-BrAoGias.js";const U=({isOpen:I,onClose:b})=>{const[w,j]=v.useState(""),[y,A]=v.useState(!1),{user:o}=T(),{bowlers:C,a3Cases:N,reorderBowlers:$,reorderA3Cases:F}=E(),r=M();if(!I)return null;const S=(n,d)=>{const g=new Set(d.map(a=>a.id)),i=n.map((a,u)=>g.has(a.id)?u:-1).filter(a=>a!==-1),t=n.filter(a=>!g.has(a.id));if(i.length===0)return[...t,...d];const l=Math.min(...i),c=n.slice(0,l).filter(a=>!g.has(a.id)).length,m=[...t];return m.splice(c,0,...d),m},L=async n=>{n.preventDefault();const d=((o==null?void 0:o.role)||"").trim().toLowerCase();if(!(d==="admin"||d==="super admin")){r.error("Only administrators can perform this action.");return}if(!w.trim()){r.error("Please enter at least one tag.");return}const i=w.split(",").map(t=>t.trim()).filter(t=>t.length>0);if(i.length===0){r.error("Please enter valid tags.");return}A(!0);try{const t=await B.consolidateBowlers(i);if(t.success){const l=t.bowlers||[],c=t.a3Cases||[],m=new Set(C.map(e=>e.id)),a=new Set(N.map(e=>e.id)),u=l.filter(e=>!m.has(e.id)).length,h=l.filter(e=>m.has(e.id)).length,p=c.filter(e=>!a.has(e.id)).length,x=c.filter(e=>a.has(e.id)).length,O=u+p,k=h+x;if(O>0||k>0){if(l.length>0){const f=S(C,l);$(f)}if(c.length>0){const f=S(N,c);F(f)}const e=[];u>0&&e.push(`${u} bowlers added`),h>0&&e.push(`${h} bowlers updated`),p>0&&e.push(`${p} A3s added`),x>0&&e.push(`${x} A3s updated`),r.success(`Successfully consolidated: ${e.join(", ")}.`),o!=null&&o.username&&B.appendAuditLog({id:P(),type:"consolidate_run",username:o.username,timestamp:new Date().toISOString(),summary:`Consolidated data for tags: ${i.join(", ")}`,details:{tags:i,addedBowlersCount:u,updatedBowlersCount:h,addedA3Count:p,updatedA3Count:x}}).catch(f=>{console.error("Failed to persist consolidation audit log",f)})}else r.info("No new or updated items found with these tags.");b(),j("")}else r.error("Failed to consolidate items.")}catch(t){console.error("Consolidate error:",t),r.error("An error occurred during consolidation.")}finally{A(!1)}};return s.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-50",children:s.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md mx-4",children:[s.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-200",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Consolidate Bowlers"}),s.jsx("button",{onClick:b,className:"text-gray-400 hover:text-gray-500 transition-colors",children:s.jsx(z,{className:"w-5 h-5"})})]}),s.jsxs("form",{onSubmit:L,className:"p-4",children:[s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{htmlFor:"tags",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tag (comma separated)"}),s.jsx("input",{type:"text",id:"tags",value:w,onChange:n=>j(n.target.value),placeholder:"e.g. Technical, Urgent, Q1",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",autoFocus:!0}),s.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Enter tags to filter and consolidate bowlers and A3 cases from the database."})]}),s.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[s.jsx("button",{type:"button",onClick:b,className:"px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:y,children:"Cancel"}),s.jsxs("button",{type:"submit",disabled:y,className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center",children:[y&&s.jsx(D,{className:"w-4 h-4 mr-2 animate-spin"}),"Consolidate"]})]})]})]})})};export{U as ConsolidateModal};
