import{Z as q,r as t,O as e,S as L,X as T,a6 as W,aX as D}from"./index-Cd45AUo9.js";import{M as H}from"./MarkdownRenderer-DuWhHqO8.js";import{B as p}from"./bot-ChTysu3K.js";import{S as K}from"./send-Bf5XFnt5.js";const Z=({isOpen:r,onClose:b,initialPrompt:d})=>{const{bowlers:M,a3Cases:E,selectedModel:z}=q(),[a,n]=t.useState([]),[c,w]=t.useState(""),[o,g]=t.useState(!1),m=t.useRef(null),x=t.useRef(!1);t.useEffect(()=>{m.current&&m.current.scrollIntoView({behavior:"smooth"})},[a]);const l=async s=>{var y,v,N,A,k,I;if(!s.trim()||o)return;const i={role:"user",content:s},$=[...a,i];n($),w(""),g(!0);try{const h={role:"system",content:`You are an AI assistant for the Metric Bowler & A3 Problem Solving application. 
        Here is the current data in the application: ${D(M,E)}.
        Answer the user's questions based on this data. Be concise and helpful.
        When a question involves a specific metric, look for any A3 cases whose linkedMetricIds include that metric's id.
        If there are completed A3 cases linked to the metric, briefly comment on whether performance appears to have improved since those A3s were closed and suggest the next step (for example: sustain, follow-up A3, or additional countermeasures).`},B=a.filter(f=>f.role!=="system"),R=[h,...B,i],u=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:z,messages:R,stream:!1})});if(!u.ok)throw new Error(`API Error: ${u.statusText}`);const C=await u.json(),P=((N=(v=(y=C.choices)==null?void 0:y[0])==null?void 0:v.message)==null?void 0:N.content)||((I=(k=(A=C.choices)==null?void 0:A[0])==null?void 0:k.delta)==null?void 0:I.content)||"Sorry, I couldn't generate a response.";n(f=>[...f,{role:"assistant",content:P}])}catch(S){console.error("AI Chat Error:",S),n(h=>[...h,{role:"assistant",content:"Sorry, there was an error communicating with the AI. Please try again later."}])}finally{g(!1)}},j=()=>l(c);return t.useEffect(()=>{r&&d&&!x.current&&(l(d),x.current=!0),r||(x.current=!1,n([]))},[r,d]),r?e.jsx("div",{className:"fixed inset-0 z-[70] overflow-hidden","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity",onClick:b}),e.jsx("div",{className:"pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10",children:e.jsx("div",{className:"pointer-events-auto w-screen max-w-xl transform transition-transform duration-300 ease-in-out",children:e.jsxs("div",{className:"flex h-full flex-col overflow-hidden bg-white shadow-2xl",children:[e.jsx("div",{className:"bg-gradient-to-r from-brand-600 to-accent-600 px-6 py-5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-white/20 rounded-lg backdrop-blur-sm border border-white/10",children:e.jsx(L,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-white tracking-tight",id:"modal-title",children:"AI Coach"}),e.jsx("p",{className:"text-xs text-brand-50 font-medium opacity-90",children:"Analyzing your Bowler metrics & A3 cases"})]})]}),e.jsxs("button",{type:"button",className:"rounded-lg p-2 text-white/70 hover:text-white hover:bg-white/10 transition-all focus:outline-none focus:ring-2 focus:ring-white/50",onClick:b,children:[e.jsx("span",{className:"sr-only",children:"Close panel"}),e.jsx(T,{className:"h-5 w-5"})]})]})}),e.jsxs("div",{className:"flex-1 flex flex-col p-6 overflow-y-auto bg-slate-50 scroll-smooth custom-scrollbar",children:[a.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center p-8 opacity-0 animate-in fade-in slide-in-from-bottom-4 duration-700 fill-mode-forwards",children:[e.jsx("div",{className:"w-20 h-20 bg-white rounded-3xl shadow-lg shadow-brand-100 flex items-center justify-center mb-6 ring-1 ring-slate-100",children:e.jsx(p,{className:"w-10 h-10 text-brand-500"})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 mb-2",children:"How can I help you today?"}),e.jsx("p",{className:"text-sm text-slate-500 max-w-xs mx-auto leading-relaxed",children:"I have access to your performance data. Ask me to analyze trends, summarize A3s, or suggest countermeasures."}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 mt-8 w-full max-w-xs",children:[e.jsx("button",{onClick:()=>l("What are my top failing metrics?"),className:"text-xs text-left px-4 py-3 bg-white hover:bg-brand-50 hover:text-brand-700 text-slate-600 rounded-xl border border-slate-200 hover:border-brand-200 transition-all shadow-sm",children:"What are my top failing metrics?"}),e.jsx("button",{onClick:()=>l("Summarize my open A3 cases"),className:"text-xs text-left px-4 py-3 bg-white hover:bg-brand-50 hover:text-brand-700 text-slate-600 rounded-xl border border-slate-200 hover:border-brand-200 transition-all shadow-sm",children:"Summarize my open A3 cases"})]})]}),e.jsxs("div",{className:"space-y-6",children:[a.map((s,i)=>e.jsx("div",{className:`flex w-full ${s.role==="user"?"justify-end":"justify-start"} animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsxs("div",{className:`flex max-w-[85%] ${s.role==="user"?"flex-row-reverse":"flex-row"} gap-3`,children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${s.role==="user"?"bg-brand-100 text-brand-600":"bg-accent-100 text-accent-600"}`,children:s.role==="user"?e.jsx("div",{className:"text-xs font-bold",children:"You"}):e.jsx(p,{className:"w-4 h-4"})}),e.jsx("div",{className:`rounded-2xl px-5 py-4 shadow-sm text-sm leading-relaxed ${s.role==="user"?"bg-brand-600 text-white rounded-tr-none":"bg-white text-slate-700 border border-slate-100 rounded-tl-none shadow-slate-100"}`,children:s.role==="user"?e.jsx("div",{className:"whitespace-pre-wrap",children:s.content}):e.jsx("div",{className:"prose prose-sm prose-slate max-w-none prose-p:my-1 prose-headings:text-slate-800 prose-headings:font-bold prose-strong:text-slate-800 prose-ul:my-2 prose-li:my-0.5",children:e.jsx(H,{content:s.content})})})]})},i)),o&&e.jsx("div",{className:"flex justify-start w-full animate-in fade-in slide-in-from-bottom-2",children:e.jsxs("div",{className:"flex max-w-[85%] flex-row gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-accent-100 text-accent-600 flex items-center justify-center flex-shrink-0",children:e.jsx(p,{className:"w-4 h-4"})}),e.jsxs("div",{className:"bg-white border border-slate-100 rounded-2xl rounded-tl-none px-5 py-4 shadow-sm flex items-center gap-3",children:[e.jsx(W,{className:"w-4 h-4 animate-spin text-accent-500"}),e.jsx("span",{className:"text-sm font-medium text-slate-500",children:"Analyzing data..."})]})]})}),e.jsx("div",{ref:m,className:"h-4"})]})]}),e.jsxs("div",{className:"p-4 bg-white border-t border-slate-100",children:[e.jsxs("div",{className:"relative flex items-end gap-2 bg-slate-50 p-2 rounded-2xl border border-slate-200 focus-within:border-brand-300 focus-within:ring-4 focus-within:ring-brand-50 transition-all",children:[e.jsx("textarea",{className:"flex-1 bg-transparent border-0 focus:ring-0 text-slate-800 placeholder:text-slate-400 text-sm resize-none py-2.5 px-3 max-h-32 min-h-[44px]",placeholder:"Ask a question about your metrics...",rows:1,value:c,onChange:s=>w(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),j())},disabled:o}),e.jsx("button",{onClick:j,disabled:o||!c.trim(),className:"mb-1 mr-1 p-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700 disabled:bg-slate-200 disabled:text-slate-400 transition-all shadow-sm active:scale-95 flex items-center justify-center",children:e.jsx(K,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-[10px] text-center text-slate-400 mt-3 font-medium",children:"AI can make mistakes. Verify important information."})]})]})})})]})}):null};export{Z as AIChatModal};
