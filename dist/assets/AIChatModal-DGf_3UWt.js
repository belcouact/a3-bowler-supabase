import{c as B,Y as L,r as t,O as e,S as $,X as z,aK as H,a3 as K}from"./index-CBHpqXov.js";import{M as W}from"./MarkdownRenderer-DV83VRSI.js";import{generateAIContext as Y}from"./aiService-BdGNG9_S.js";/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=B("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),D=({isOpen:r,onClose:f,initialPrompt:i})=>{const{bowlers:M,a3Cases:C,selectedModel:E}=L(),[a,n]=t.useState([]),[c,p]=t.useState(""),[o,g]=t.useState(!1),d=t.useRef(null),m=t.useRef(!1);t.useEffect(()=>{d.current&&d.current.scrollIntoView({behavior:"smooth"})},[a]);const b=async s=>{var w,j,v,N,A,k;if(!s.trim()||o)return;const l={role:"user",content:s},T=[...a,l];n(T),p(""),g(!0);try{const u={role:"system",content:`You are an AI assistant for the Metric Bowler & A3 Problem Solving application. 
        Here is the current data in the application: ${Y(M,C)}.
        Answer the user's questions based on this data. Be concise and helpful.
        When a question involves a specific metric, look for any A3 cases whose linkedMetricIds include that metric's id.
        If there are completed A3 cases linked to the metric, briefly comment on whether performance appears to have improved since those A3s were closed and suggest the next step (for example: sustain, follow-up A3, or additional countermeasures).`},q=a.filter(x=>x.role!=="system"),P=[u,...q,l],h=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:E,messages:P,stream:!1})});if(!h.ok)throw new Error(`API Error: ${h.statusText}`);const S=await h.json(),R=((v=(j=(w=S.choices)==null?void 0:w[0])==null?void 0:j.message)==null?void 0:v.content)||((k=(A=(N=S.choices)==null?void 0:N[0])==null?void 0:A.delta)==null?void 0:k.content)||"Sorry, I couldn't generate a response.";n(x=>[...x,{role:"assistant",content:R}])}catch(I){console.error("AI Chat Error:",I),n(u=>[...u,{role:"assistant",content:"Sorry, there was an error communicating with the AI. Please try again later."}])}finally{g(!1)}},y=()=>b(c);return t.useEffect(()=>{r&&i&&!m.current&&(b(i),m.current=!0),r||(m.current=!1,n([]))},[r,i]),r?e.jsx("div",{className:"fixed inset-0 z-[70] overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity",onClick:f}),e.jsx("div",{className:"pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10",children:e.jsx("div",{className:"pointer-events-auto w-screen max-w-md",children:e.jsxs("div",{className:"flex h-full flex-col overflow-y-scroll bg-white shadow-xl",children:[e.jsxs("div",{className:"bg-blue-600 px-4 py-6 sm:px-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-medium text-white flex items-center",id:"modal-title",children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"AI Assistant"]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("button",{type:"button",className:"rounded-md text-blue-200 hover:text-white focus:outline-none focus:ring-2 focus:ring-white",onClick:f,children:[e.jsx("span",{className:"sr-only",children:"Close panel"}),e.jsx(z,{className:"h-6 w-6"})]})})]}),e.jsx("p",{className:"mt-1 text-sm text-blue-200",children:"Ask questions about your metrics and A3 cases."})]}),e.jsxs("div",{className:"flex-1 flex flex-col p-4 overflow-y-auto bg-gray-50",children:[a.length===0&&e.jsxs("div",{className:"text-center text-gray-500 mt-10",children:[e.jsx(H,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"Hello! I have access to your current Bowler and A3 data."}),e.jsx("p",{className:"text-sm mt-2",children:'Try asking: "What is the trend for Safety metric?" or "Summarize my open A3 cases".'})]}),a.map((s,l)=>e.jsx("div",{className:`mb-4 flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-lg px-4 py-3 shadow-sm ${s.role==="user"?"bg-blue-600 text-white rounded-br-none":"bg-white text-gray-800 border border-gray-200 rounded-bl-none"}`,children:s.role==="user"?e.jsx("div",{className:"whitespace-pre-wrap",children:s.content}):e.jsx(W,{content:s.content})})},l)),o&&e.jsx("div",{className:"flex justify-start mb-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm rounded-bl-none flex items-center",children:[e.jsx(K,{className:"w-4 h-4 animate-spin text-blue-600 mr-2"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Thinking..."})]})}),e.jsx("div",{ref:d})]}),e.jsx("div",{className:"border-t border-gray-200 px-4 py-4 bg-white",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"text",className:"flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border",placeholder:"Type your message...",value:c,onChange:s=>p(s.target.value),onKeyPress:s=>s.key==="Enter"&&y(),disabled:o}),e.jsx("button",{onClick:y,disabled:o||!c.trim(),className:"inline-flex items-center p-2 border border-transparent rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-300",children:e.jsx(J,{className:"h-5 w-5"})})]})})]})})})]})}):null};export{D as AIChatModal};
