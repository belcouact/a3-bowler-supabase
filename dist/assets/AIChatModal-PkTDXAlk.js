import{a1 as q,r as t,O as e,X as H,S as K,Y as U,am as V,a9 as X,aY as F}from"./index-BMbMkMjb.js";import{M as J}from"./MarkdownRenderer-CFyEjgIW.js";import{B as g}from"./bot-D1QM8yal.js";import{S as O}from"./send-DfBFFgjl.js";const ee=({isOpen:l,onClose:v,initialPrompt:c})=>{const{bowlers:R,a3Cases:T,selectedModel:L}=q(),[n,o]=t.useState([]),[m,j]=t.useState(""),[i,y]=t.useState(!1),x=t.useRef(null),h=t.useRef(!1),[$,W]=t.useState(400),[u,N]=t.useState(!1),B=t.useRef(null);t.useEffect(()=>{x.current&&x.current.scrollIntoView({behavior:"smooth"})},[n]),t.useEffect(()=>{const s=f=>{if(!u)return;const r=window.innerWidth-f.clientX;r>300&&r<800&&W(r)},a=()=>{N(!1)};return u&&(document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)),()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)}},[u]);const d=async s=>{var r,A,I,M,S,E;if(!s.trim()||i)return;const a={role:"user",content:s},f=[...n,a];o(f),j(""),y(!0);try{const p={role:"system",content:`You are an AI assistant for the Metric Bowler & A3 Problem Solving application. 
        Here is the current data in the application: ${F(R,T)}.
        Answer the user's questions based on this data. Be concise and helpful.
        When a question involves a specific metric, look for any A3 cases whose linkedMetricIds include that metric's id.
        If there are completed A3 cases linked to the metric, briefly comment on whether performance appears to have improved since those A3s were closed and suggest the next step (for example: sustain, follow-up A3, or additional countermeasures).`},D=n.filter(w=>w.role!=="system"),P=[p,...D,a],b=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:L,messages:P,stream:!1})});if(!b.ok)throw new Error(`API Error: ${b.statusText}`);const z=await b.json(),Y=((I=(A=(r=z.choices)==null?void 0:r[0])==null?void 0:A.message)==null?void 0:I.content)||((E=(S=(M=z.choices)==null?void 0:M[0])==null?void 0:S.delta)==null?void 0:E.content)||"Sorry, I couldn't generate a response.";o(w=>[...w,{role:"assistant",content:Y}])}catch(C){console.error("AI Chat Error:",C),o(p=>[...p,{role:"assistant",content:"Sorry, there was an error communicating with the AI. Please try again later."}])}finally{y(!1)}},k=()=>d(m);return t.useEffect(()=>{l&&c&&!h.current&&(d(c),h.current=!0),l||(h.current=!1,o([]))},[l,c]),l?e.jsx("div",{className:"fixed inset-0 z-[70] overflow-hidden","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity",onClick:v}),e.jsx("div",{className:"fixed inset-y-0 right-0 flex max-w-full pointer-events-none",children:e.jsxs("div",{ref:B,style:{width:`${$}px`},className:"pointer-events-auto relative h-full bg-white shadow-2xl flex flex-col transform transition-transform ease-in-out duration-300",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 cursor-ew-resize hover:bg-brand-500/50 transition-colors z-50 flex items-center justify-center group",onMouseDown:s=>{s.preventDefault(),N(!0)},children:e.jsx("div",{className:"h-8 w-0.5 bg-slate-300 rounded-full group-hover:bg-brand-500 transition-colors"})}),e.jsxs("div",{className:"flex h-full flex-col overflow-hidden bg-white",children:[e.jsxs("div",{className:"bg-white border-b border-slate-100 px-4 py-3 flex items-center justify-between shadow-sm z-10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 bg-brand-50 rounded-lg border border-brand-100",children:e.jsx(g,{className:"w-4 h-4 text-brand-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-bold text-slate-800",id:"modal-title",children:"AI Coach"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"relative flex h-2 w-2",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2 w-2 bg-emerald-500"})]}),e.jsx("p",{className:"text-[10px] text-slate-500 font-medium",children:"Online"})]})]})]}),e.jsxs("button",{type:"button",className:"rounded-lg p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all",onClick:v,children:[e.jsx("span",{className:"sr-only",children:"Close panel"}),e.jsx(H,{className:"h-4 w-4"})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col p-4 overflow-y-auto bg-slate-50 scroll-smooth custom-scrollbar",children:[n.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center p-6 text-slate-500",children:[e.jsx("div",{className:"w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-100 flex items-center justify-center mb-3",children:e.jsx(K,{className:"w-5 h-5 text-brand-500"})}),e.jsx("h3",{className:"text-sm font-bold text-slate-800 mb-1",children:"How can I help?"}),e.jsx("p",{className:"text-xs text-slate-500 max-w-[240px] mx-auto mb-6 leading-relaxed",children:"I can analyze your metrics, suggest countermeasures, or draft A3 content."}),e.jsxs("div",{className:"flex flex-col gap-2 w-full max-w-xs",children:[e.jsxs("button",{onClick:()=>d("What are my top failing metrics?"),className:"text-xs text-left px-3 py-2 bg-white hover:bg-brand-50 hover:text-brand-700 text-slate-600 rounded-lg border border-slate-200 hover:border-brand-200 transition-all shadow-sm flex items-center justify-between group",children:[e.jsx("span",{children:"Top failing metrics?"}),e.jsx(U,{className:"w-3 h-3 text-slate-300 group-hover:text-brand-400 transition-colors"})]}),e.jsxs("button",{onClick:()=>d("Summarize my open A3 cases"),className:"text-xs text-left px-3 py-2 bg-white hover:bg-brand-50 hover:text-brand-700 text-slate-600 rounded-lg border border-slate-200 hover:border-brand-200 transition-all shadow-sm flex items-center justify-between group",children:[e.jsx("span",{children:"Summarize open A3 cases"}),e.jsx(V,{className:"w-3 h-3 text-slate-300 group-hover:text-brand-400 transition-colors"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[n.map((s,a)=>e.jsx("div",{className:`flex w-full ${s.role==="user"?"justify-end":"justify-start"} animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsxs("div",{className:`flex max-w-[90%] ${s.role==="user"?"flex-row-reverse":"flex-row"} gap-2`,children:[s.role!=="user"&&e.jsx("div",{className:"w-6 h-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center flex-shrink-0 mt-1",children:e.jsx(g,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:`rounded-2xl px-4 py-2.5 shadow-sm text-sm leading-relaxed ${s.role==="user"?"bg-brand-600 text-white rounded-tr-none":"bg-white text-slate-700 border border-slate-200 rounded-tl-none"}`,children:s.role==="user"?e.jsx("div",{className:"whitespace-pre-wrap",children:s.content}):e.jsx("div",{className:"prose prose-sm prose-slate max-w-none prose-p:my-1 prose-headings:text-slate-800 prose-headings:font-bold prose-strong:text-slate-800 prose-ul:my-2 prose-li:my-0.5",children:e.jsx(J,{content:s.content})})})]})},a)),i&&e.jsx("div",{className:"flex justify-start w-full animate-in fade-in slide-in-from-bottom-2",children:e.jsxs("div",{className:"flex max-w-[85%] flex-row gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center flex-shrink-0 mt-1",children:e.jsx(g,{className:"w-3.5 h-3.5"})}),e.jsxs("div",{className:"bg-white border border-slate-200 rounded-2xl rounded-tl-none px-4 py-2.5 shadow-sm flex items-center gap-2",children:[e.jsx(X,{className:"w-3.5 h-3.5 animate-spin text-brand-500"}),e.jsx("span",{className:"text-xs font-medium text-slate-500",children:"Thinking..."})]})]})}),e.jsx("div",{ref:x,className:"h-2"})]})]}),e.jsxs("div",{className:"p-3 bg-white border-t border-slate-100",children:[e.jsxs("div",{className:"relative flex items-end gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-200 focus-within:border-brand-300 focus-within:ring-2 focus-within:ring-brand-50 transition-all",children:[e.jsx("textarea",{className:"flex-1 bg-transparent border-0 focus:ring-0 text-slate-800 placeholder:text-slate-400 text-sm resize-none py-2 px-2 max-h-32 min-h-[40px]",placeholder:"Type a message...",rows:1,value:m,onChange:s=>j(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),k())},disabled:i}),e.jsx("button",{onClick:k,disabled:i||!m.trim(),className:"mb-0.5 mr-0.5 p-1.5 rounded-lg bg-brand-600 text-white hover:bg-brand-700 disabled:bg-slate-200 disabled:text-slate-400 transition-all shadow-sm active:scale-95 flex items-center justify-center shrink-0",children:e.jsx(O,{className:"h-3.5 w-3.5"})})]}),e.jsx("p",{className:"text-[9px] text-center text-slate-400 mt-2 font-medium",children:"AI can make mistakes. Verify important information."})]})]})]})})]})}):null};export{ee as AIChatModal};
