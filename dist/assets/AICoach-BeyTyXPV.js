import{$ as D,a1 as H,r as i,O as e,a9 as A}from"./index-BMbMkMjb.js";import{M as L}from"./MarkdownRenderer-CFyEjgIW.js";import{S as P}from"./send-DfBFFgjl.js";import{A as J}from"./alert-triangle-CsMKoJjB.js";const M={},G=()=>{const{id:I}=D(),{a3Cases:C,bowlers:E,selectedModel:S}=H(),s=C.find(t=>t.id===I),[c,d]=i.useState([]),[h,y]=i.useState(""),[m,w]=i.useState(!1),p=i.useRef(null);i.useEffect(()=>{p.current&&p.current.scrollIntoView({behavior:"smooth"})},[c]),i.useEffect(()=>{if(!s)return;const t=s.id,o=M[t];if(o&&o.length>0){d(o);return}const r={role:"assistant",content:`I am your AI coach focusing specifically on this A3: **${s.title||"this A3"}**.

I already know the problem statement, analysis, and plan that you have entered.
Ask me anything to help you think through root causes, risks, action plans, or follow-up.

Examples:
- "What are the top risks or uncertainties in this A3?"
- "How can we strengthen the action plan using industry best practices?"
- "What should we watch in the data to confirm this A3 is working?"`};d([r])},[s]),i.useEffect(()=>{s&&(M[s.id]=c)},[s,c]);const T=t=>{if(!s)return"";const o=s.linkedMetricIds||[],l=[];E.forEach(a=>{(a.metrics||[]).forEach(n=>{o.includes(n.id)&&l.push({bowlerName:a.name,bowlerGroup:a.group||"Ungrouped",metric:{id:n.id,name:n.name,definition:n.definition,owner:n.owner,scope:n.scope,attribute:n.attribute,targetMeetingRule:n.targetMeetingRule,monthlyData:n.monthlyData}})})});const r={...s};delete r.mindMapNodes,delete r.dataAnalysisImages,delete r.resultImages,delete r.dataAnalysisCanvasHeight,delete r.resultCanvasHeight;const u=t.filter(a=>a.role==="user"||a.role==="assistant").map(a=>({role:a.role,content:a.content}));return JSON.stringify({a3Case:r,linkedMetrics:l,conversation:u})},R=async t=>{var r,u,a,f,n,v;if(!t.trim()||m||!s)return;const o={role:"user",content:t},l=[...c,o];d(l),y(""),w(!0);try{const x=l.filter(b=>b.role!=="system"),$=[{role:"system",content:`You are an AI coach helping the owner of a single A3 case.

Here is the JSON context for this A3, including any linked metrics:
${T(x)}

Your job is to answer any questions the user has about this A3 and its related metrics.
Examples include: clarifying the problem, commenting on data and analysis, suggesting root-cause checks, highlighting risks or uncertainties, advising on action plan design and prioritization, or discussing follow-up and sustainment.

Keep your answers specific, practical, and focused on this A3 only.`},...x],g=await fetch("https://multi-model-worker.study-llm.me/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:S,messages:$,stream:!1})});if(!g.ok)throw new Error(`API Error: ${g.statusText}`);const k=await g.json(),O=((a=(u=(r=k.choices)==null?void 0:r[0])==null?void 0:u.message)==null?void 0:a.content)||((v=(n=(f=k.choices)==null?void 0:f[0])==null?void 0:n.delta)==null?void 0:v.content)||"Sorry, I couldn't generate a response.";d(b=>[...b,{role:"assistant",content:O}])}catch{d(N=>[...N,{role:"assistant",content:"Sorry, there was an error communicating with the AI coach. Please try again later."}])}finally{w(!1)}},j=()=>{h.trim()&&R(h)};return s?e.jsxs("div",{className:"max-w-7xl mx-auto flex flex-col h-full min-h-[500px] space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[e.jsxs("div",{className:"flex-1 flex flex-col rounded-2xl border border-slate-200 bg-slate-50/30 overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"flex-1 p-6 overflow-y-auto space-y-4",children:[c.map((t,o)=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"} animate-in fade-in slide-in-from-bottom-2 duration-300`,children:e.jsx("div",{className:`max-w-[85%] rounded-2xl px-5 py-3.5 shadow-sm ${t.role==="user"?"bg-brand-600 text-white rounded-br-none shadow-brand-200/50":"bg-white text-slate-800 border border-slate-200 rounded-bl-none"}`,children:t.role==="user"?e.jsx("div",{className:"whitespace-pre-wrap text-sm leading-relaxed font-medium",children:t.content}):e.jsx("div",{className:"text-sm leading-relaxed prose prose-slate prose-sm max-w-none",children:e.jsx(L,{content:t.content})})})},o)),m&&e.jsx("div",{className:"flex justify-start animate-pulse",children:e.jsxs("div",{className:"bg-white border border-slate-200 rounded-2xl px-5 py-3.5 shadow-sm rounded-bl-none flex items-center gap-3",children:[e.jsx(A,{className:"w-4 h-4 animate-spin text-brand-600"}),e.jsx("span",{className:"text-sm text-slate-500 font-medium",children:"Thinking..."})]})}),e.jsx("div",{ref:p})]}),e.jsx("div",{className:"border-t border-slate-200 bg-white px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",className:"flex-1 bg-slate-50 rounded-xl border-slate-200 text-sm py-2.5 px-4 focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all placeholder-slate-400",placeholder:"Ask the coach about this A3...",value:h,onChange:t=>y(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),j())},disabled:m}),e.jsx("button",{type:"button",onClick:j,disabled:m||!h.trim(),className:"inline-flex items-center justify-center w-10 h-10 rounded-xl bg-brand-600 text-white hover:bg-brand-700 transition-all shadow-md hover:shadow-lg disabled:bg-slate-300 disabled:shadow-none shrink-0",children:e.jsx(P,{className:"h-5 w-5"})})]})})]}),!s.problemStatement&&e.jsxs("div",{className:"rounded-xl bg-accent-50 border border-accent-100 px-4 py-3 flex items-start gap-3",children:[e.jsx(J,{className:"h-5 w-5 text-accent-600 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-accent-900 font-medium",children:"Tip: The coach works best when the problem statement, analysis, and action plan are filled in."})]})]}):e.jsx("div",{className:"flex items-center justify-center py-24",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(A,{className:"w-10 h-10 animate-spin text-brand-600"}),e.jsx("p",{className:"mt-4 text-slate-500 font-medium animate-pulse",children:"Loading coaching session..."})]})})};export{G as default};
