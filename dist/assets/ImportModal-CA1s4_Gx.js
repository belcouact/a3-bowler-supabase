import{r as M,Z as oe,O as e,X as re,av as ae,af as le,ac as ce}from"./index-BUcG817Z.js";import{A as _}from"./alert-circle-JGAVFjXv.js";import{C as de}from"./check-Bs8wEwRH.js";const xe=({isOpen:H,onClose:y,onImport:ee})=>{const[h,S]=M.useState(null),[$,k]=M.useState(null),[j,R]=M.useState(null),B=M.useRef(null),V=oe();if(!H)return null;const te=d=>{var u;const l=(u=d.target.files)==null?void 0:u[0];if(l){if(l.type!=="text/csv"&&!l.name.endsWith(".csv")){k("Please upload a valid CSV file."),S(null);return}S(l),k(null),R(null)}},se=d=>{const l=d.split(`
`);if(l.length<2)throw new Error("File is empty or missing headers");const u=t=>{const s=[];let o="",c=!1;for(let r=0;r<t.length;r++){const a=t[r];a==='"'?c=!c:a===","&&!c?(s.push(o.trim()),o=""):o+=a}return s.push(o.trim()),s.map(r=>r.replace(/^"|"$/g,"").replace(/""/g,'"'))},i=u(l[0]),x=i.findIndex(t=>t.toLowerCase().includes("bowler name")),N=i.findIndex(t=>t.toLowerCase().includes("description")),C=i.findIndex(t=>t.toLowerCase().includes("group")),g=i.findIndex(t=>t.toLowerCase().includes("champion")),W=i.findIndex(t=>t.toLowerCase().includes("commitment")),Y=i.findIndex(t=>t.toLowerCase().includes("tag")),P=i.findIndex(t=>t.toLowerCase().includes("metric name")),U=i.findIndex(t=>t.toLowerCase().includes("definition")),G=i.findIndex(t=>t.toLowerCase().includes("owner")),z=i.findIndex(t=>t.toLowerCase().includes("attribute")),J=i.findIndex(t=>t.toLowerCase().includes("target rule")||t.toLowerCase().includes("meeting rule")),K=i.findIndex(t=>t.toLowerCase().includes("scope")),T=i.findIndex(t=>t.toLowerCase()==="type");if(x===-1)throw new Error('Missing required column: "Bowler Name"');if(P===-1)throw new Error('Missing required column: "Metric Name"');if(K===-1)throw new Error('Missing required column: "Scope"');const D=[];i.forEach((t,s)=>{const o=t.toLowerCase(),c=r=>{const a=r.split("/");if(a.length===2){const f=a[0],b=a[1],p=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(b.toLowerCase().substring(0,3));if(p!==-1)return`${f}-${String(p+1).padStart(2,"0")}`}return null};if(o.endsWith(" target")||o.endsWith(" actual")){const r=o.endsWith(" target"),a=t.substring(0,t.lastIndexOf(" ")),f=c(a);f&&D.push({index:s,type:r?"target":"actual",key:f})}else{const r=c(t);r&&D.push({index:s,type:"dynamic",key:r})}});const w={};let Q=0;for(let t=1;t<l.length;t++){if(!l[t].trim())continue;const s=u(l[t]),o=s[x];if(!o)continue;const c=s[P];if(!c)continue;const r=s[K],a=N!==-1?s[N]:void 0,f=C!==-1?s[C]:void 0,b=g!==-1?s[g]:void 0,p=W!==-1?s[W]:void 0,E=Y!==-1?s[Y]:void 0,F=U!==-1?s[U]:"",q=G!==-1?s[G]:"",O=z!==-1?s[z]:"",X=J!==-1?s[J]:void 0;let v;if(X){const n=X.toLowerCase().trim();(n==="gte"||n==="lte"||n==="within_range")&&(v=n)}let I=null;if(T!==-1&&s[T]){const n=s[T].toLowerCase();n.includes("target")?I="target":n.includes("actual")&&(I="actual")}if(!w[o])w[o]={bowler:{name:o,description:a,group:f,champion:b,commitment:p,tag:E},metrics:[]};else{const n=w[o].bowler;a&&(n.description=a),f&&(n.group=f),b&&(n.champion=b),p&&(n.commitment=p),E&&(n.tag=E)}const Z=w[o].metrics;let m=Z.find(n=>n.name===c);m?(F&&(m.definition=F),q&&(m.owner=q),O&&(m.attribute=O),v&&(m.targetMeetingRule=v)):(m={id:ce(),name:c,scope:r,definition:F,owner:q,attribute:O,targetMeetingRule:v,monthlyData:{}},Z.push(m));const L=m.monthlyData||{};D.forEach(n=>{if(s[n.index]!==void 0){const ie=s[n.index];let A=n.type;if(A==="dynamic"){if(!I)return;A=I}L[n.key]||(L[n.key]={target:"",actual:""}),L[n.key][A]=ie}}),m.monthlyData=L,Q++}return{data:w,rowCount:Q,colCount:i.length}},ne=()=>{if(!h)return;const d=new FileReader;d.onload=l=>{var u;try{const i=(u=l.target)==null?void 0:u.result,{data:x,rowCount:N,colCount:C}=se(i);ee(x);const g=`Successfully imported data: ${N} rows and ${C} columns processed.`;R(g),V.success(g),setTimeout(()=>{y(),R(null),S(null)},1500)}catch(i){const x=i.message||"Failed to parse CSV";k(x),V.error(`Import Failed: ${x}`)}},d.readAsText(h)};return e.jsx("div",{className:"fixed inset-0 z-[70] overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:y}),e.jsx("span",{className:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true",children:"â€‹"}),e.jsxs("div",{className:"inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6",children:[e.jsx("div",{className:"hidden sm:block absolute top-0 right-0 pt-4 pr-4",children:e.jsxs("button",{type:"button",className:"bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",onClick:y,children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(re,{className:"h-6 w-6"})]})}),e.jsxs("div",{className:"sm:flex sm:items-start",children:[e.jsx("div",{className:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10",children:e.jsx(ae,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900",id:"modal-title",children:"Import Metrics Data"}),e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Upload a CSV file to update metrics. New metrics will be created if they don't exist."}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-md mb-4 text-left",children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-2 flex items-center",children:[e.jsx(_,{className:"h-4 w-4 mr-1.5 text-blue-500"}),"Required Columns"]}),e.jsxs("ul",{className:"text-xs text-gray-600 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Bowler Name"})," (Required)"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Metric Name"})," (Required)"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Scope"})," (Required)"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Type"})," (Required)"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Bowler Description, Group, Champion, Commitment, Tag"})," (Optional)"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-mono font-medium",children:"Definition, Owner, Attribute, Target Meeting Rule"})," (Optional)"]}),e.jsxs("li",{children:["Recommended format (matches Download CSV):",e.jsx("br",{}),e.jsx("span",{className:"font-mono font-medium",children:"Type"})," column with values ",e.jsx("span",{className:"font-mono",children:"Target"})," or ",e.jsx("span",{className:"font-mono",children:"Actual"}),", plus date columns ",e.jsx("span",{className:"font-mono",children:"YYYY/MMM"}),".",e.jsx("br",{}),e.jsx("span",{className:"text-gray-400 italic",children:'Example header: "Bowler Name","Bowler Description","Group","Tag","Metric Name","Definition","Owner","Scope","Attribute","Target Meeting Rule","Type","2024/Jan","2024/Feb",...'})]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("input",{type:"file",ref:B,accept:".csv",onChange:te,className:"hidden"}),e.jsxs("button",{type:"button",onClick:()=>{var d;return(d=B.current)==null?void 0:d.click()},className:"w-full flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(le,{className:"h-5 w-5 mr-2 text-gray-400"}),h?h.name:"Select CSV File"]})]}),$&&e.jsxs("div",{className:"mt-2 text-sm text-red-600 flex items-center",children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),$]}),j&&e.jsxs("div",{className:"mt-2 text-sm text-green-600 flex items-center",children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),j]})]})]})]}),e.jsxs("div",{className:"mt-5 sm:mt-4 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{type:"button",onClick:ne,disabled:!h||!!j,className:`w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm ${!h||j?"opacity-50 cursor-not-allowed":""}`,children:"Import"}),e.jsx("button",{type:"button",onClick:y,className:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm",children:"Cancel"})]})]})]})})};export{xe as ImportModal};
