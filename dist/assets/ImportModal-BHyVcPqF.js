import{r as j,a2 as ue,O as e,aq as te,X as fe,a7 as pe,d as q,U as se,ak as he,ah as ge}from"./index-BMbMkMjb.js";import{D as be}from"./database-DBvnF0lE.js";import{A as we}from"./arrow-right-BcN1lMFX.js";const ye=({isOpen:re,onClose:N,onImport:ne})=>{const[c,D]=j.useState(null),[M,S]=j.useState(null),[g,F]=j.useState(null),[ae,R]=j.useState(!1),z=j.useRef(null),P=ue();if(!re)return null;const oe=n=>{var u;const l=(u=n.target.files)==null?void 0:u[0];l&&U(l)},U=n=>{if(n.type!=="text/csv"&&!n.name.endsWith(".csv")){S("Please upload a valid CSV file."),D(null);return}D(n),S(null),F(null)},ie=n=>{n.preventDefault(),R(!0)},le=()=>{R(!1)},de=n=>{n.preventDefault(),R(!1);const l=n.dataTransfer.files[0];l&&U(l)},ce=n=>{const l=n.split(`
`);if(l.length<2)throw new Error("File is empty or missing headers");const u=t=>{const s=[];let o="",m=!1;for(let i=0;i<t.length;i++){const d=t[i];d==='"'?m=!m:d===","&&!m?(s.push(o.trim()),o=""):o+=d}return s.push(o.trim()),s.map(i=>i.replace(/^"|"$/g,"").replace(/""/g,'"'))},a=u(l[0]),p=a.findIndex(t=>t.toLowerCase().includes("bowler name")),y=a.findIndex(t=>t.toLowerCase().includes("description")),I=a.findIndex(t=>t.toLowerCase().includes("group")),b=a.findIndex(t=>t.toLowerCase().includes("champion")),W=a.findIndex(t=>t.toLowerCase().includes("commitment")),Y=a.findIndex(t=>t.toLowerCase().includes("tag")),K=a.findIndex(t=>t.toLowerCase().includes("metric name")),G=a.findIndex(t=>t.toLowerCase().includes("definition")),Q=a.findIndex(t=>t.toLowerCase().includes("owner")),X=a.findIndex(t=>t.toLowerCase().includes("attribute")),_=a.findIndex(t=>t.toLowerCase().includes("target rule")||t.toLowerCase().includes("meeting rule")),H=a.findIndex(t=>t.toLowerCase().includes("scope")),T=a.findIndex(t=>t.toLowerCase()==="type");if(p===-1)throw new Error('Missing required column: "Bowler Name"');if(K===-1)throw new Error('Missing required column: "Metric Name"');if(H===-1)throw new Error('Missing required column: "Scope"');const E=[];a.forEach((t,s)=>{const o=t.toLowerCase(),m=i=>{const d=i.split("/");if(d.length===2){const f=d[0],v=d[1],h=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(v.toLowerCase().substring(0,3));if(h!==-1)return`${f}-${String(h+1).padStart(2,"0")}`}return null};if(o.endsWith(" target")||o.endsWith(" actual")){const i=o.endsWith(" target"),d=t.substring(0,t.lastIndexOf(" ")),f=m(d);f&&E.push({index:s,type:i?"target":"actual",key:f})}else{const i=m(t);i&&E.push({index:s,type:"dynamic",key:i})}});const w={};let J=0;for(let t=1;t<l.length;t++){if(!l[t].trim())continue;const s=u(l[t]),o=s[p];if(!o)continue;const m=s[K];if(!m)continue;const i=s[H],d=y!==-1?s[y]:void 0,f=I!==-1?s[I]:void 0,v=b!==-1?s[b]:void 0,h=W!==-1?s[W]:void 0,$=Y!==-1?s[Y]:void 0,B=G!==-1?s[G]:"",O=Q!==-1?s[Q]:"",A=X!==-1?s[X]:"",Z=_!==-1?s[_]:void 0;let C;if(Z){const r=Z.toLowerCase().trim();(r==="gte"||r==="lte"||r==="within_range")&&(C=r)}let L=null;if(T!==-1&&s[T]){const r=s[T].toLowerCase();r.includes("target")?L="target":r.includes("actual")&&(L="actual")}if(!w[o])w[o]={bowler:{name:o,description:d,group:f,champion:v,commitment:h,tag:$},metrics:[]};else{const r=w[o].bowler;d&&(r.description=d),f&&(r.group=f),v&&(r.champion=v),h&&(r.commitment=h),$&&(r.tag=$)}const ee=w[o].metrics;let x=ee.find(r=>r.name===m);x?(B&&(x.definition=B),O&&(x.owner=O),A&&(x.attribute=A),C&&(x.targetMeetingRule=C)):(x={id:ge(),name:m,scope:i,definition:B,owner:O,attribute:A,targetMeetingRule:C,monthlyData:{}},ee.push(x));const k=x.monthlyData||{};E.forEach(r=>{if(s[r.index]!==void 0){const xe=s[r.index];let V=r.type;if(V==="dynamic"){if(!L)return;V=L}k[r.key]||(k[r.key]={target:"",actual:""}),k[r.key][V]=xe}}),x.monthlyData=k,J++}return{data:w,rowCount:J,colCount:a.length}},me=()=>{if(!c)return;const n=new FileReader;n.onload=l=>{var u;try{const a=(u=l.target)==null?void 0:u.result,{data:p,rowCount:y,colCount:I}=ce(a);ne(p);const b=`Successfully imported ${y} rows across ${I} columns.`;F(b),P.success(b),setTimeout(()=>{N(),F(null),D(null)},1500)}catch(a){const p=a.message||"Failed to parse CSV";S(p),P.error(`Import Failed: ${p}`)}},n.readAsText(c)};return e.jsxs("div",{className:"fixed inset-0 z-[70] flex items-center justify-center p-4 sm:p-6",children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity animate-in fade-in duration-300",onClick:N}),e.jsxs("div",{className:"relative w-full max-w-lg bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col animate-in fade-in scale-in-95 duration-500",children:[e.jsxs("div",{className:"px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-2.5 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl shadow-sm border border-indigo-100/50",children:e.jsx(be,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 leading-none",children:"Import Metrics Data"}),e.jsxs("p",{className:"mt-1.5 text-xs font-medium text-slate-500 flex items-center gap-1.5",children:[e.jsx(te,{className:"w-3.5 h-3.5 text-indigo-500"}),"Bulk synchronize performance dashboards"]})]})]}),e.jsx("button",{onClick:N,className:"p-2 hover:bg-slate-50 rounded-xl text-slate-400 hover:text-slate-600 transition-all border border-transparent hover:border-slate-100 active:scale-95",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-4 rounded-xl border border-blue-100 bg-blue-50/40 px-4 py-4",children:[e.jsx("div",{className:"p-2 bg-white rounded-lg shadow-sm border border-blue-50",children:e.jsx(pe,{className:"h-5 w-5 text-blue-500"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-bold text-blue-900",children:"Format Guide"}),e.jsxs("p",{className:"text-xs text-blue-700 leading-relaxed",children:["Upload a CSV file containing ",e.jsx("span",{className:"font-bold",children:"Bowler Name"}),", ",e.jsx("span",{className:"font-bold",children:"Metric Name"}),", and ",e.jsx("span",{className:"font-bold",children:"Type"}),". The system will auto-map dates in YYYY/MMM format."]})]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["Bowler Name","Metric Name","Scope","Type"].map(n=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-slate-50 rounded-lg border border-slate-100",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-500"}),e.jsx("span",{className:"text-[11px] font-bold text-slate-600 uppercase tracking-tight",children:n})]},n))})]}),e.jsxs("div",{onDragOver:ie,onDragLeave:le,onDrop:de,onClick:()=>{var n;return(n=z.current)==null?void 0:n.click()},className:q("relative border-2 border-dashed rounded-2xl p-10 flex flex-col items-center justify-center transition-all cursor-pointer group",ae?"bg-indigo-50 border-indigo-400 shadow-inner":c?"bg-emerald-50 border-emerald-300 shadow-sm":"bg-slate-50 border-slate-200 hover:bg-slate-100 hover:border-slate-300 hover:shadow-md"),children:[e.jsx("input",{type:"file",ref:z,accept:".csv",onChange:oe,className:"hidden"}),e.jsx("div",{className:q("w-16 h-16 rounded-2xl flex items-center justify-center mb-4 transition-all duration-300 group-hover:scale-110 group-hover:rotate-3 shadow-sm",c?"bg-gradient-to-br from-emerald-100 to-teal-100 text-emerald-600 ring-4 ring-emerald-50":"bg-gradient-to-br from-indigo-100 to-blue-100 text-indigo-600 ring-4 ring-indigo-50"),children:c?e.jsx(se,{className:"w-8 h-8"}):e.jsx(te,{className:"w-8 h-8"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-bold text-slate-700",children:c?c.name:"Drop your CSV file here"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1 font-medium",children:c?`${(c.size/1024).toFixed(1)} KB`:"or click to browse from files"})]}),c&&!g&&!M&&e.jsx("div",{className:"mt-4 px-3 py-1 bg-white border border-emerald-200 rounded-full text-[10px] font-bold text-emerald-600 animate-bounce shadow-sm",children:"File ready for import"})]}),M&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-red-50 border border-red-100 rounded-xl text-red-700 animate-in fade-in slide-in-from-top-2",children:[e.jsx(he,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("p",{className:"text-xs font-bold",children:M})]}),g&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-emerald-50 border border-emerald-100 rounded-xl text-emerald-700 animate-in fade-in slide-in-from-top-2",children:[e.jsx(se,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("p",{className:"text-xs font-bold",children:g})]})]}),e.jsxs("div",{className:"px-6 py-5 bg-slate-50 border-t border-slate-100 flex gap-3",children:[e.jsx("button",{type:"button",onClick:N,className:"flex-1 px-6 py-2.5 text-sm font-bold text-slate-600 hover:text-slate-800 hover:bg-white rounded-xl transition-all border border-slate-200 hover:border-slate-300 active:scale-95",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:me,disabled:!c||!!g,className:q("flex-[2] px-6 py-2.5 text-sm font-bold rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-indigo-100",!c||g?"bg-slate-200 text-slate-400 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"),children:["Start Processing",e.jsx(we,{className:"w-4 h-4"})]})]})]})]})};export{ye as ImportModal};
