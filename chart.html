<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据分析</title>
    <link rel="icon" href="assets/icons/alex.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Luckysheet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/assets/iconfont/iconfont.css">
    
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- ECharts for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        /* Mobile-first responsive styles */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #ffffff;
            --darker: #f8fafc;
            --light: #1f2937;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --glass-bg: #f9fafb;
            --glass-border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 1.5rem;
            background: #ffffff;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
            min-height: calc(100vh - 80px);
        }

        /* Upload Section - Minimized */
        .upload-section {
            background: #ffffff;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 8px;
            padding: 1rem 1rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--glass-bg);
            margin-bottom: 1rem;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #e0f2fe;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #dbeafe;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .file-input {
            display: none;
        }

        /* Buttons - Compact */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            line-height: 1;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
            text-align: center;
            gap: 0.4rem;
            min-height: 44px; /* Touch target size for mobile */
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: #ffffff;
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-label i {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: #ffffff;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: inherit;
            resize: vertical;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* File Info - Compact */
        .file-info {
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            display: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .file-info.show {
            display: block;
        }

        .file-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Sheet Selector - Compact */
        .sheet-selector {
            display: none;
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .sheet-selector h3 {
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .sheet-selector.show {
            display: block;
        }

        .sheet-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .sheet-item {
            padding: 0.5rem 1rem;
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .sheet-item:hover {
            background: #e0f2fe;
            color: var(--primary);
            transform: translateY(-1px);
        }

        .sheet-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Luckysheet Container */
        .luckysheet-container {
            background: #ffffff;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: none;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .luckysheet-container.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .luckysheet-container.show {
            display: block;
        }

        /* Analysis and Chart Section */
        .analysis-section {
            background: #ffffff;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: block;
        }

        .analysis-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            color: #856404;
        }

        .analysis-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-type-btn {
            padding: 0.5rem 1rem;
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .chart-type-btn:hover {
            background: #e0f2fe;
            color: var(--primary);
            border-color: var(--primary);
        }

        .chart-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .analysis-result {
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .analysis-result.show {
            display: block;
        }

        .chart-container {
            width: 100%;
            height: 560px;
            margin: 1rem 0;
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .chart-content {
            width: 100%;
            height: 100%;
        }

        /* Chart view separate button */
        .chart-view-separate {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: var(--transition);
            z-index: 10;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chart-view-separate:hover {
            background: rgba(255, 255, 255, 1);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .chart-view-separate i {
            font-size: 1.1rem;
        }

        /* Model Selection Section */
        .model-selection-section {
            background: #ffffff;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .model-selection {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: var(--transition);
            flex: 1;
            justify-content: center;
            background: #ffffff;
        }
        
        .radio-option:hover {
            background: #e0f2fe;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }
        
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .radio-option input[type="radio"]:checked + label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            background: #dbeafe;
            border: 1px solid var(--primary);
        }

        @media (max-width: 768px) {
            .model-selection {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .luckysheet-container {
                padding: 0.5rem;
                min-height: 300px;
            }
            
            #luckysheet {
                height: 400px !important;
            }
            
            .luckysheet-container .luckysheet-grid-window {
                height: 350px !important;
            }
        }
        
        @media (max-width: 480px) {
            .luckysheet-container {
                border-radius: 12px;
                padding: 0.25rem;
            }
            
            #luckysheet {
                height: 350px !important;
            }
            
            .luckysheet-container .luckysheet-grid-window {
                height: 300px !important;
            }
        }

        .code-output {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #e2e8f0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .code-output-container {
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .code-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--glass-bg);
            border-bottom: 1px solid var(--glass-border);
        }

        .code-output-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .code-output-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .btn-icon:hover {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .code-output-editable {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            background: #1e293b;
            color: #e2e8f0;
            border: none;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .code-output-editable.expanded {
            max-height: 800px;
            min-height: 400px;
        }

        .result-card {
            background: #ffffff;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .analysis-controls {
                flex-direction: column;
            }
            
            .chart-type-selector {
                justify-content: center;
            }
            
            .chart-container {
                height: 300px;
                padding: 0.5rem;
            }
            
            .chart-view-separate {
                top: 0.25rem;
                right: 0.25rem;
                padding: 0.375rem;
                font-size: 0.875rem;
            }
            
            .chart-view-separate i {
                font-size: 1rem;
            }
        }

        #luckysheet {
            width: 100%;
            height: 500px;
            margin: 0;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }

        /* Luckysheet grid containment */
        .luckysheet-container .luckysheet-grid-window,
        .luckysheet-container .luckysheet-grid-container {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        .luckysheet-container .luckysheet-cell-main {
            max-width: 100% !important;
        }

        .luckysheet-container .luckysheet-cell-canvas {
            max-width: 100% !important;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .status-message.show {
            display: flex;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        /* Chart Generation Section */
        .chart-generation-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: block;
        }

        .chart-generation-controls {
            margin: 1.5rem 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .analysis-controls {
            margin: 1.5rem 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .chart-result {
            margin-top: 2rem;
            display: none;
        }

        .chart-result.show {
            display: block;
        }

        .chart-result-header {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .chart-result-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-result-title i {
            color: var(--primary);
        }

        .chart-result-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-icon {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--glass-border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .header {
                padding: 1rem 2rem;
            }

            .main-container {
                padding: 2rem;
            }

            .upload-section {
                padding: 2.5rem 2rem;
            }

            .section-title {
                font-size: 1.75rem;
            }

            .upload-area {
                padding: 3rem 2rem;
                min-height: 250px;
            }

            .upload-icon {
                font-size: 4rem;
            }

            .upload-text {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.875rem 1.75rem;
                font-size: 1rem;
                min-height: 52px;
            }

            #luckysheet {
                height: 600px;
            }

            .luckysheet-container {
                padding: 1.5rem;
            }

            .action-buttons {
                justify-content: flex-start;
            }
        }

        @media (min-width: 1024px) {
            .header-content {
                padding: 0 1rem;
            }

            .upload-section {
                padding: 3rem 2.5rem;
            }

            .section-title {
                font-size: 2rem;
            }

            .upload-area {
                padding: 4rem 3rem;
                min-height: 300px;
            }

            .upload-icon {
                font-size: 5rem;
            }

            .upload-text {
                font-size: 1.5rem;
            }

            #luckysheet {
                height: 700px;
            }

            .luckysheet-container {
                padding: 2rem;
            }

            .btn {
                padding: 1rem 2rem;
                min-height: 56px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .upload-area:active {
                transform: scale(0.98);
                background: rgba(99, 102, 241, 0.2);
            }

            .btn:active {
                transform: scale(0.95);
            }

            .sheet-item:active {
                transform: scale(0.95);
            }

            /* Mobile Luckysheet adjustments */
            .luckysheet-container {
                padding: 0.5rem;
                border-radius: 12px;
            }

            #luckysheet {
                height: 400px;
                border-radius: 6px;
            }

            /* Ensure touch scrolling works */
            .luckysheet-container {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Wide screen styles for analysis controls */
        @media (min-width: 1024px) {
            .analysis-controls {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }
            
            .analysis-note {
                width: 100%;
            }
            
            #analyzeDataBtn {
                align-self: center;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .upload-section,
            .action-buttons {
                display: none;
            }

            .luckysheet-container {
                background: white;
                border: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-table"></i>
                <span>数据分析</span>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i>
                    返回首页
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Upload Section -->
        <section class="upload-section">
            <h2 class="section-title">
                <i class="fas fa-cloud-upload-alt"></i>
                文件上传
            </h2>
            
            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>
            
            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="upload-text">拖拽文件到此处或点击上传</div>
                <div class="upload-hint">
                    支持 CSV, XLS, XLSX 格式
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xls,.xlsx" multiple>
            </div>

            <!-- File Info -->
            <div id="fileInfo" class="file-info">
                <div class="file-details">
                    <div>
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <button class="btn btn-danger" onclick="clearFile()">
                        <i class="fas fa-times"></i>
                        清除
                    </button>
                </div>
            </div>

            <!-- Sheet Selector -->
            <div id="sheetSelector" class="sheet-selector">
                <h3>选择工作表：</h3>
                <div class="sheet-list" id="sheetList"></div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" id="loadBtn" onclick="loadToLuckysheet()" disabled>
                    <i class="fas fa-table"></i>
                    加载到表格
                </button>
                <button class="btn btn-secondary" onclick="clearLuckysheet()">
                    <i class="fas fa-eraser"></i>
                    清空表格
                </button>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在处理文件，请稍候...</p>
            </div>
        </section>

        <!-- Luckysheet Container -->
        <section class="luckysheet-container" id="luckysheetContainer">
            <h2 class="section-title">
                <i class="fas fa-spreadsheet"></i>
                数据预览&编辑
            </h2>
            <div id="luckysheet-loading" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>正在加载数据表格...</p>
            </div>
            <div id="luckysheet" style="display: none;"></div>
        </section>

        <!-- Model Selection Section -->
        <section class="model-selection-section">
            <h2 class="section-title">
                <i class="fas fa-robot"></i>
                模型选择
            </h2>
            <div class="model-selection">
                <div class="radio-option">
                    <input type="radio" id="model-deepseek" name="model-selection" value="deepseek" checked>
                    <label for="model-deepseek">DeepSeek</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="model-kimi" name="model-selection" value="kimi">
                    <label for="model-kimi">Kimi</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="model-glm" name="model-selection" value="glm">
                    <label for="model-glm">GLM</label>
                </div>
            </div>
        </section>

        <!-- Data Analysis Section -->
        <section class="analysis-section" id="analysisSection">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i>
                数据分析
            </h2>
            
            <div class="analysis-note">
                <i class="fas fa-info-circle" style="color: #f39c12; margin-right: 8px;"></i>
                <strong>提示：</strong>在文件上传后，请先在worksheet中清理不必要的数据，仅保留分析所需的数据行和列，并确保每列抬头名称清除易懂，以获得更快且准确的结果。
            </div>
            
            <!-- Data Background Input -->
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label" for="dataBackground">
                    <i class="fas fa-info-circle"></i> 数据背景说明（可选）
                </label>
                <textarea id="dataBackground" class="form-input" rows="3" placeholder="请提供数据背景信息，帮助AI更好地理解您的数据：
• 表头字段的业务含义（如：销售额、客户数量、时间等）
• 数据的业务场景（如：电商销售数据、用户行为数据等）
• 希望重点分析的内容（如：找出销售趋势、识别异常值等）
• 任何特殊的数据处理要求"></textarea>
            </div>
            
            <!-- Analysis Controls -->
            <div class="analysis-controls">
                <button class="btn btn-primary" id="analyzeDataBtn" onclick="performDataAnalysis()">
                    <i class="fas fa-chart-pie"></i>
                    数据分析
                </button>
            </div>

            <!-- Analysis Result -->
            <div id="analysisContent"></div>
        </section>

        <!-- Chart Generation Section -->
        <section class="chart-generation-section" id="chartGenerationSection">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                图表生成
            </h2>
            
            <!-- User Requirement Input -->
            <div class="form-group">
                <label class="form-label" for="chartRequirement">
                    <i class="fas fa-edit"></i> 图表需求描述
                </label>
                <textarea id="chartRequirement" class="form-input" rows="4" placeholder="请详细描述您想要生成的图表需求，例如：
• 分析销售数据的月度趋势，使用折线图展示
• 比较各部门的销售额，用柱状图显示
• 展示市场份额分布，使用饼图
• 显示温度与销量的关系，用散点图

系统将自动选择合适的图表类型并生成相应代码"></textarea>
            </div>
            
            <!-- Chart Type Selector - Removed, users now describe requirements in text -->
            <!-- <div class="chart-type-selector" id="chartTypeSelector">
                <button class="chart-type-btn active" data-type="bar">柱状图</button>
                <button class="chart-type-btn" data-type="line">折线图</button>
                <button class="chart-type-btn" data-type="pie">饼图</button>
                <button class="chart-type-btn" data-type="scatter">散点图</button>
                <button class="chart-type-btn" data-type="radar">雷达图</button>
            </div> -->

            <!-- Chart Generation Controls -->
            <div class="chart-generation-controls">
                <button class="btn btn-primary" id="generateChartBtn" onclick="generateChartCode()">
                    <i class="fas fa-code"></i>
                    生成图表代码
                </button>
                <button class="btn btn-secondary" id="executeScriptBtn" onclick="executeChartScript()" style="margin-left: 1rem;" disabled>
                    <i class="fas fa-play"></i>
                    执行脚本
                </button>
            </div>

            <!-- Chart Result -->
            <div class="chart-result" id="chartResult">
                <!-- Chart Result Header -->
                <div class="chart-result-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.5rem 0;">
                    <div class="chart-result-title">
                        <i class="fas fa-chart-area"></i>
                        图表结果
                    </div>
                </div>
                
                <!-- Code Output -->
                <div class="code-output-container">
                    <div class="code-output-header">
                        <span class="code-output-title">图表代码</span>
                        <div class="code-output-actions">
                            <button class="btn-icon" id="expandCodeBtn" onclick="toggleCodeEditor()" title="展开/收起编辑器">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <textarea id="codeOutput" class="code-output-editable" placeholder="生成的图表代码将显示在这里，您可以编辑后执行"></textarea>
                </div>
                
                <!-- Chart Container -->
                <div id="chartContainer" class="chart-container">
                    <button class="chart-view-separate" onclick="viewChartInNewWindow()" title="在新窗口中查看图表">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                    <div id="chartContent" class="chart-content"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Luckysheet JS -->
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>

    <script>
        // Global variables
        let currentFile = null;
        let workbook = null;
        let selectedSheet = 0;
        let luckysheetInstance = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeUploadArea();
            initializeLuckysheet();
            // Show data analysis section by default
            const analysisSection = document.getElementById('analysisSection');
            if (analysisSection) analysisSection.classList.add('show');
        });

        // Initialize upload area
        function initializeUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Click to upload
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // Initialize Luckysheet
        function initializeLuckysheet() {
            try {
                const options = {
                    container: 'luckysheet',
                    title: '数据预览&编辑',
                    lang: 'zh',
                    showinfobar: false,
                    showsheetbar: true,
                    showtoolbar: true,
                    showstatisticBar: true,
                    enableAddRow: true,
                    enableAddCol: true,
                    sheetFormulaBar: true,
                    sheetRightClickConfig: {
                        copy: true,
                        paste: true,
                        delete: true,
                        insert: true,
                        hide: true,
                        column: true,
                        row: true
                    },
                    // Start with blank sheet - no sample data
                };

                luckysheet.create(options);
                luckysheetInstance = luckysheet;
                
                // Show Luckysheet container immediately
                const luckysheetContainer = document.getElementById('luckysheetContainer');
                if (luckysheetContainer) {
                    luckysheetContainer.classList.add('show');
                }
                
                // Show analysis section
                const analysisSection = document.getElementById('analysisSection');
                if (analysisSection) {
                    analysisSection.classList.add('show');
                }
                
                // Force resize and contain properly
                setTimeout(() => {
                    if (luckysheet && luckysheet.resize) {
                        luckysheet.resize();
                    }
                    // Ensure container stays within bounds
                    const container = document.getElementById('luckysheetContainer');
                    const luckysheetEl = document.getElementById('luckysheet');
                    const loadingEl = document.getElementById('luckysheet-loading');
                    
                    if (container && luckysheetEl && loadingEl) {
                        container.style.overflow = 'hidden';
                        luckysheetEl.style.maxWidth = '100%';
                        
                        // Hide loading indicator and show Luckysheet
                        loadingEl.style.display = 'none';
                        luckysheetEl.style.display = 'block';
                        
                        // Trigger another resize after showing
                        setTimeout(() => {
                            if (luckysheet && luckysheet.resize) {
                                luckysheet.resize();
                            }
                        }, 50);
                    }
                    
                    // Prevent auto-scroll when clicking cells
                    preventLuckysheetScroll();
                    
                    console.log('Luckysheet initialized successfully with sample data');
                }, 100);
                
            } catch (error) {
                console.error('Luckysheet initialization failed:', error);
                showStatus('Luckysheet初始化失败，请刷新页面重试', 'error');
            }
        }

        // Handle file selection
        function handleFileSelect(file) {
            // Validate file - only allow XLS, XLSX, CSV formats
            const validExtensions = ['.csv', '.xls', '.xlsx'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!validExtensions.includes(fileExtension)) {
                showStatus('请选择有效的CSV、XLS或XLSX文件！', 'error');
                return;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('文件大小超过10MB限制！', 'error');
                return;
            }

            currentFile = file;
            displayFileInfo(file);
            parseFile(file);
        }

        // Display file information
        function displayFileInfo(file) {
            const fileName = document.getElementById('fileName');
            if (fileName) fileName.textContent = file.name;
            
            const fileSize = document.getElementById('fileSize');
            if (fileSize) fileSize.textContent = formatFileSize(file.size);
            
            const fileInfo = document.getElementById('fileInfo');
            if (fileInfo) fileInfo.classList.add('show');
            
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) loadBtn.disabled = false;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Parse file
        function parseFile(file) {
            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // Handle CSV
                        parseCSV(data);
                    } else {
                        // Handle Excel
                        parseExcel(data);
                    }
                } catch (error) {
                    showStatus('文件解析失败：' + error.message, 'error');
                    showLoading(false);
                }
            };
            
            reader.onerror = function() {
                showStatus('文件读取失败！', 'error');
                showLoading(false);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Parse CSV file
        function parseCSV(data) {
            try {
                const text = new TextDecoder('utf-8').decode(data);
                const lines = text.split('\n').filter(line => line.trim());
                
                const result = [];
                lines.forEach(line => {
                    const row = line.split(',').map(cell => cell.trim().replace(/^["']|["']$/g, ''));
                    result.push(row);
                });

                workbook = [{
                    name: 'Sheet1',
                    data: result
                }];

                displaySheets();
                showStatus('CSV文件解析成功！', 'success');
                showLoading(false);
            } catch (error) {
                showStatus('CSV解析失败：' + error.message, 'error');
                showLoading(false);
            }
        }

        // Parse Excel file
        function parseExcel(data) {
            try {
                const wb = XLSX.read(data, { type: 'array' });
                workbook = [];

                wb.SheetNames.forEach(sheetName => {
                    const worksheet = wb.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    workbook.push({
                        name: sheetName,
                        data: jsonData
                    });
                });

                displaySheets();
                showStatus(`Excel文件解析成功！共${workbook.length}个工作表`, 'success');
                showLoading(false);
            } catch (error) {
                showStatus('Excel解析失败：' + error.message, 'error');
                showLoading(false);
            }
        }

        // Display sheet selector
        function displaySheets() {
            if (workbook.length <= 1) {
                const sheetSelector = document.getElementById('sheetSelector');
                if (sheetSelector) sheetSelector.classList.remove('show');
                selectedSheet = 0;
            } else {
                const sheetList = document.getElementById('sheetList');
                if (!sheetList) return;
                
                sheetList.innerHTML = '';
                
                workbook.forEach((sheet, index) => {
                    const sheetItem = document.createElement('div');
                    sheetItem.className = 'sheet-item';
                    sheetItem.textContent = sheet.name;
                    sheetItem.onclick = () => selectSheet(index);
                    
                    if (index === 0) {
                        sheetItem.classList.add('active');
                    }
                    
                    sheetList.appendChild(sheetItem);
                });
                
                const sheetSelector = document.getElementById('sheetSelector');
                if (sheetSelector) sheetSelector.classList.add('show');
            }
        }

        // Select sheet
        function selectSheet(index) {
            selectedSheet = index;
            
            // Update active state
            document.querySelectorAll('.sheet-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        // Load data to Luckysheet
        function loadToLuckysheet() {
            if (!workbook || workbook.length === 0) {
                showStatus('请先上传文件！', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const selectedData = workbook[selectedSheet].data;
                
                // Validate data
                if (!selectedData || selectedData.length === 0) {
                    throw new Error('数据为空或格式不正确');
                }
                
                // Create Luckysheet data format
                const sheetData = [];
                
                // Add data rows with proper formatting
                for (let r = 0; r < selectedData.length; r++) {
                    sheetData[r] = [];
                    for (let c = 0; c < selectedData[r].length; c++) {
                        const value = selectedData[r][c];
                        if (value !== null && value !== undefined && value !== '') {
                            sheetData[r][c] = {
                                v: value,
                                ct: { fa: 'General', t: typeof value === 'number' ? 'n' : 'g' }
                            };
                        } else {
                            sheetData[r][c] = null;
                        }
                    }
                }
                
                // Create options for Luckysheet
                const options = {
                    container: 'luckysheet',
                    title: '数据表格',
                    lang: 'zh',
                    showinfobar: false,
                    showsheetbar: true,
                    showstatisticBar: false,
                    showtoolbar: true,
                    allowEdit: true,
                    enableAddRow: false,
                    enableAddCol: false,
                    rowHeaderWidth: 46,
                    columnHeaderHeight: 20,
                    defaultRowHeight: 25,
                    defaultColWidth: 73,
                    cellRightClickConfig: {
                        copy: true,
                    },
                    data: [{
                        name: workbook[selectedSheet].name || 'Sheet1',
                        data: sheetData
                    }]
                };
                
                // Recreate Luckysheet instance with new data
                if (window.luckysheet && window.luckysheet.create) {
                    window.luckysheet.create(options);
                    luckysheetInstance = window.luckysheet;
                } else {
                    throw new Error('Luckysheet未加载或不可用');
                }

                // Show Luckysheet container
                const luckysheetContainer = document.getElementById('luckysheetContainer');
                if (luckysheetContainer) luckysheetContainer.classList.add('show');
                
                // Show analysis section when data is loaded
                const analysisSection = document.getElementById('analysisSection');
                if (analysisSection) analysisSection.classList.add('show');
                
                // Force Luckysheet to resize and contain properly
                setTimeout(() => {
                    if (luckysheet && luckysheet.resize) {
                        luckysheet.resize();
                    }
                    // Ensure container stays within bounds
                    const container = document.getElementById('luckysheetContainer');
                    const luckysheetEl = document.getElementById('luckysheet');
                    if (container && luckysheetEl) {
                        container.style.overflow = 'hidden';
                        luckysheetEl.style.maxWidth = '100%';
                    }
                    
                    // Prevent auto-scroll when clicking cells
                    preventLuckysheetScroll();
                }, 100);
                
                showStatus('数据已成功加载到Luckysheet！', 'success');
                showLoading(false);
                
                // Scroll to Luckysheet
                const luckysheetContainerScroll = document.getElementById('luckysheetContainer');
                if (luckysheetContainerScroll) {
                    luckysheetContainerScroll.scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }
                
            } catch (error) {
                console.error('Luckysheet加载错误:', error);
                showStatus('加载到Luckysheet失败：' + error.message, 'error');
                showLoading(false);
            }
        }

        // Clear file
        function clearFile() {
            currentFile = null;
            workbook = null;
            selectedSheet = 0;
            
            // Add null checks for all elements
            const fileInfo = document.getElementById('fileInfo');
            if (fileInfo) fileInfo.classList.remove('show');
            
            const sheetSelector = document.getElementById('sheetSelector');
            if (sheetSelector) sheetSelector.classList.remove('show');
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) loadBtn.disabled = true;
            
            // Clear analysis results but keep section visible
            const analysisResult = document.getElementById('analysisResult');
            if (analysisResult) analysisResult.classList.remove('show');
            
            hideStatus();
        }

        // Clear Luckysheet
        function clearLuckysheet() {
            try {
                // Clean up scroll prevention
                if (window._cleanupLuckysheetScrollBase) {
                    window._cleanupLuckysheetScrollBase();
                    delete window._cleanupLuckysheetScrollBase;
                }
                
                // Create empty data
                const emptyData = [];
                for (let r = 0; r < 100; r++) {
                    emptyData[r] = [];
                    for (let c = 0; c < 26; c++) {
                        emptyData[r][c] = null;
                    }
                }
                
                // Create options for empty Luckysheet
                const options = {
                    container: 'luckysheet',
                    title: '数据表格',
                    lang: 'zh',
                    showinfobar: false,
                    showsheetbar: true,
                    showstatisticBar: false,
                    showtoolbar: true,
                    allowEdit: true,
                    enableAddRow: false,
                    enableAddCol: false,
                    rowHeaderWidth: 46,
                    columnHeaderHeight: 20,
                    defaultRowHeight: 25,
                    defaultColWidth: 73,
                    cellRightClickConfig: {
                        copy: true,
                    },
                    data: [{
                        name: 'Sheet1',
                        data: emptyData
                    }]
                };
                
                // Recreate Luckysheet instance with empty data
                if (window.luckysheet && window.luckysheet.create) {
                    window.luckysheet.create(options);
                    luckysheetInstance = window.luckysheet;
                } else {
                    throw new Error('Luckysheet未加载或不可用');
                }
                
                // Hide container - add null check
                const luckysheetContainer = document.getElementById('luckysheetContainer');
                if (luckysheetContainer) {
                    luckysheetContainer.classList.remove('show');
                }
                
                // Clear analysis results but keep section visible - add null check
                const analysisResult = document.getElementById('analysisResult');
                if (analysisResult) {
                    analysisResult.classList.remove('show');
                }
                
                showStatus('Luckysheet已清空！', 'success');
            } catch (error) {
                console.error('清空Luckysheet错误:', error);
                showStatus('清空Luckysheet失败：' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.className = `status-message show status-${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            else if (type === 'error') icon = 'fas fa-exclamation-circle';
            
            statusElement.innerHTML = `<i class="${icon}"></i> ${message}`;
            
            // Auto hide after 5 seconds
            setTimeout(hideStatus, 5000);
        }

        // Hide status message
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.classList.remove('show');
            }
        }

        // Show/hide loading
        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.classList.toggle('show', show);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + O: Open file
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.click();
            }
            
            // Ctrl/Cmd + L: Load to Luckysheet
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                const loadBtn = document.getElementById('loadBtn');
                if (loadBtn && !loadBtn.disabled) {
                    loadToLuckysheet();
                }
            }
            
            // Escape: Clear file
            if (e.key === 'Escape') {
                e.preventDefault();
                clearFile();
            }
        });

        // Window resize handler to contain Luckysheet
        window.addEventListener('resize', function() {
            const luckysheetContainer = document.getElementById('luckysheetContainer');
            if (luckysheetContainer && luckysheetContainer.classList.contains('show')) {
                setTimeout(() => {
                    if (luckysheet && luckysheet.resize) {
                        luckysheet.resize();
                    }
                    // Ensure container stays within bounds
                    const container = document.getElementById('luckysheetContainer');
                    const luckysheetEl = document.getElementById('luckysheet');
                    if (container && luckysheetEl) {
                        container.style.overflow = 'hidden';
                        luckysheetEl.style.maxWidth = '100%';
                    }
                }, 100);
            }
        });

        // Data Analysis Functions
        let currentChart = null;
        let generatedChartCode = '';

        // Get data from Luckysheet
        function getLuckysheetData() {
            if (typeof luckysheet === 'undefined' || !luckysheet.getSheetData) {
                console.warn('Luckysheet未加载或getSheetData方法不可用');
                return null;
            }
            
            try {
                const luckysheetData = luckysheet.getSheetData();
                // console.log('Luckysheet原始数据:', luckysheetData);
                
                if (!luckysheetData) {
                    console.warn('Luckysheet返回空数据');
                    return null;
                }
                
                let actualData = [];
                let headers = [];
                
                // 处理不同的数据结构
                if (luckysheetData.data && Array.isArray(luckysheetData.data) && luckysheetData.data.length > 0) {
                    actualData = luckysheetData.data;
                    // 从第一行提取表头
                    if (actualData.length > 0) {
                        headers = actualData[0].map((cell, index) => {
                            if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {
                                return String(cell.v);
                            } else if (cell && cell.m !== undefined && cell.m !== null && cell.m !== '') {
                                return String(cell.m);
                            } else {
                                return `列${index + 1}`;
                            }
                        });
                    }
                } else if (Array.isArray(luckysheetData) && luckysheetData.length > 0) {
                    actualData = luckysheetData;
                    // 从第一行提取表头
                    if (actualData.length > 0) {
                        headers = actualData[0].map((cell, index) => {
                            if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') {
                                return String(cell.v);
                            } else if (cell && cell.m !== undefined && cell.m !== null && cell.m !== '') {
                                return String(cell.m);
                            } else {
                                return `列${index + 1}`;
                            }
                        });
                    }
                } else {
                    console.warn('Luckysheet中没有数据，数据结构:', luckysheetData);
                    return null;
                }
                
                // 转换数据格式：提取单元格的值
                const convertedData = actualData.map((row, rowIndex) => {
                    return row.map((cell, colIndex) => {
                        if (!cell) return '';
                        
                        let value = '';
                        if (cell.v !== undefined && cell.v !== null) {
                            value = cell.v;
                        } else if (cell.m !== undefined && cell.m !== null) {
                            value = cell.m;
                        } else if (typeof cell === 'object') {
                            value = JSON.stringify(cell);
                        } else {
                            value = String(cell);
                        }
                        
                        return value;
                    });
                });
                
                // Clean the data to remove empty rows and columns
                const cleanedData = cleanData(convertedData);
                
                return {
                    headers: cleanedData.length > 0 ? cleanedData[0] : headers,
                    data: cleanedData
                };
                
            } catch (error) {
                console.error('获取Luckysheet数据时出错:', error);
                return null;
            }
        }

        // Prevent Luckysheet auto-scroll when clicking cells
        function preventLuckysheetScroll() {
            console.log('设置Luckysheet点击事件处理');
            
            // 获取Luckysheet容器
            const luckysheetContainer = document.getElementById('luckysheetContainer');
            if (!luckysheetContainer) return;
            
            // 检测是否为移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                          window.innerWidth <= 768;
            
            // 移动设备上完全禁用滚动预防，因为它会导致页面冻结
            if (isMobile) {
                console.log('移动设备：禁用滚动预防功能以避免页面冻结');
                
                // 确保页面可以正常滚动
                document.body.style.overflow = 'auto';
                document.body.style.position = 'relative';
                document.body.style.touchAction = 'auto';
                
                // 确保Luckysheet容器不会阻止页面滚动
                luckysheetContainer.style.overflow = 'visible';
                luckysheetContainer.style.position = 'relative';
                
                // 添加一个空的清理函数以避免错误
                window._cleanupLuckysheetScrollBase = () => {
                    console.log('移动设备：清理空的滚动预防功能');
                };
                
                return; // 移动设备上不执行任何滚动预防逻辑
            }
            
            // 桌面设备：保持原有的滚动预防逻辑
            // 保存当前滚动位置
            let savedScrollPosition = 0;
            let isPreventingScroll = false;
            let scrollHandler = null;
            let timeoutId = null;
            let keydownHandler = null;
            
            // 处理Luckysheet单元格内的点击事件（而不是整个容器）
            const handleCellInteraction = (e) => {
                // 只处理Luckysheet单元格内的交互，而不是整个容器
                const cellElement = e.target.closest('.luckysheet-cell-main, .luckysheet-cell-selected, .luckysheet-cell-selected-focus');
                if (!cellElement && !e.target.classList.contains('luckysheet-cell-main') && 
                    !e.target.classList.contains('luckysheet-cell-selected') && 
                    !e.target.classList.contains('luckysheet-cell-selected-focus')) {
                    return; // 如果不是在单元格上交互，则不阻止滚动
                }
                
                // 保存当前滚动位置
                savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                
                // 如果已经在防滚动状态，则不做处理
                if (isPreventingScroll) return;
                
                console.log('Luckysheet单元格交互开始，保存滚动位置:', savedScrollPosition);
                
                // 设置防滚动状态
                isPreventingScroll = true;
                
                // 监听滚动事件，如果页面滚动超过阈值，则恢复到保存的位置
                scrollHandler = () => {
                    const currentScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollDiff = Math.abs(currentScrollPosition - savedScrollPosition);
                    
                    // 如果滚动超过20px，则恢复到保存的位置
                    if (scrollDiff > 20) {
                        console.log('检测到页面滚动，恢复到保存的位置:', savedScrollPosition);
                        window.scrollTo(0, savedScrollPosition);
                    }
                };
                
                // 添加滚动监听
                window.addEventListener('scroll', scrollHandler, { passive: false });
                
                // 设置超时自动移除防滚动功能
                timeoutId = setTimeout(() => {
                    console.log('防滚动功能超时，移除监听');
                    if (scrollHandler) {
                        window.removeEventListener('scroll', scrollHandler);
                        scrollHandler = null;
                    }
                    isPreventingScroll = false;
                }, 3000);
                
                // 监听ESC键，按下时移除防滚动功能
                keydownHandler = (e) => {
                    if (e.key === 'Escape') {
                        console.log('检测到ESC键，移除防滚动功能');
                        if (scrollHandler) {
                            window.removeEventListener('scroll', scrollHandler);
                            scrollHandler = null;
                        }
                        if (keydownHandler) {
                            document.removeEventListener('keydown', keydownHandler);
                            keydownHandler = null;
                        }
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                            timeoutId = null;
                        }
                        isPreventingScroll = false;
                    }
                };
                
                document.addEventListener('keydown', keydownHandler);
                
                // 存储清理函数以便后续调用
                window._cleanupLuckysheetScroll = () => {
                    console.log('清理Luckysheet防滚动功能');
                    if (scrollHandler) {
                        window.removeEventListener('scroll', scrollHandler);
                        scrollHandler = null;
                    }
                    if (keydownHandler) {
                        document.removeEventListener('keydown', keydownHandler);
                        keydownHandler = null;
                    }
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    isPreventingScroll = false;
                };
            };
            
            // 桌面设备：添加事件监听器
            luckysheetContainer.addEventListener('mousedown', handleCellInteraction);
            luckysheetContainer.addEventListener('touchstart', handleCellInteraction);
            
            // 存储基础清理函数
            window._cleanupLuckysheetScrollBase = () => {
                console.log('清理Luckysheet基础事件监听器');
                luckysheetContainer.removeEventListener('mousedown', handleCellInteraction);
                luckysheetContainer.removeEventListener('touchstart', handleCellInteraction);
                
                // 如果有活动的防滚动功能，也清理掉
                if (window._cleanupLuckysheetScroll) {
                    window._cleanupLuckysheetScroll();
                    delete window._cleanupLuckysheetScroll;
                }
            };
        }

        // Chart type functions removed - users now describe requirements in text
        // Get selected chart type function removed
        // Chart type selector event listeners removed

        // Clean data by removing empty rows and columns
        function cleanData(data) {
            if (!data || data.length === 0) return data;
            
            // Remove completely empty rows
            const nonEmptyRows = data.filter(row => {
                return row.some(cell => cell !== null && cell !== undefined && cell !== '');
            });
            
            if (nonEmptyRows.length === 0) return nonEmptyRows;
            
            // Find columns that have at least one non-empty value
            const cols = nonEmptyRows[0].length;
            const nonEmptyCols = [];
            
            for (let c = 0; c < cols; c++) {
                const hasValue = nonEmptyRows.some(row => {
                    return row[c] !== null && row[c] !== undefined && row[c] !== '';
                });
                if (hasValue) {
                    nonEmptyCols.push(c);
                }
            }
            
            // Remove empty columns
            const cleanedData = nonEmptyRows.map(row => {
                return nonEmptyCols.map(col => row[col]);
            });
            
            return cleanedData;
        }

        // Perform data analysis
        async function performDataAnalysis() {
            // Get data from Luckysheet instead of workbook
            const luckysheetData = getLuckysheetData();
            
            if (!luckysheetData || !luckysheetData.data || luckysheetData.data.length === 0) {
                showStatus('请先上传数据文件或在Luckysheet中输入数据！', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeDataBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';

            try {
                const cleanedData = luckysheetData.data;
                
                if (cleanedData.length === 0) {
                    throw new Error('数据为空或所有数据都是空值');
                }
                
                // 获取表头信息
                const headers = cleanedData[0];
                
                // 获取数据背景信息
                const dataBackground = document.getElementById('dataBackground').value.trim();
                
                // 获取所有清理后的数据（排除表头）
                const dataRows = cleanedData.slice(1);
                
                // 构建数据分析提示
                const analysisPrompt = `你是一个专业的数据分析师，请对以下数据集进行深入分析，提供有价值的洞察。请严格按照以下格式输出，只输出分析内容：

**完整数据集：**
${headers ? '\n**表头信息**：' + JSON.stringify(headers) : ''}
${JSON.stringify(dataRows, null, 2)}
${dataBackground ? '\n**数据背景说明**：' + dataBackground : ''}

**完整数据集说明**：请基于完整数据集进行分析。

**重要提醒：必须严格基于上述实际数据进行分析，禁止使用任何随机生成的数据、假设的数据或示例数据。所有分析结论必须完全基于提供的数据集。**

请提供以下分析：

### 1. 数据概览
基于表头信息简要描述数据集的业务含义（仅基于实际数据）

### 2. 核心发现
指出数据中的主要模式、趋势、异常和业务洞察（仅基于实际数据）

### 3. 实用建议
基于分析结果提供2-3条具体可行的业务建议（仅基于实际数据）

严格要求：
- 使用Markdown格式，结构清晰
- 内容简明扼要，突出重点
- 避免冗长的技术细节
- 专注于有价值的业务洞察
- 不要生成任何图表代码或HTML代码
- 提供可直接用于决策的建议
- **绝对禁止使用任何随机数据、假设数据或示例数据**
- **所有分析必须100%基于上述提供的实际数据**
- **如果数据不足或质量不佳，请如实说明，不要编造分析结果**`;

                // 调用API进行深度分析
                const apiAnalysis = await callAPIForAnalysis(analysisPrompt);
                
                // 显示AI深度分析结果直接在analysis-result容器中
                const analysisContent = document.getElementById('analysisContent');
                analysisContent.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">🤖 AI深度分析</h4>
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1.5rem; border-radius: 12px; border: 1px solid #90caf9; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            ${apiAnalysis.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1976d2;">$1</strong>').replace(/\*(.*?)\*/g, '<em style="color: #424242;">$1</em>')}
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <p style="margin: 0; color: #495057; font-size: 0.9rem;">
                            <i class="fas fa-info-circle" style="color: #28a745;"></i> 
                            数据已自动清理：移除了空行和空列，确保分析准确性
                        </p>
                    </div>
                `;


                document.getElementById('analysisSection').classList.add('show');
                
                showStatus('数据分析完成！', 'success');
                
            } catch (error) {
                console.error('数据分析错误:', error);
                showStatus('数据分析失败：' + error.message, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-chart-pie"></i> 数据分析';
            }
        }

        // Analyze dataset
        function analyzeDataset(data) {
            if (!data || data.length === 0) {
                throw new Error('数据为空');
            }

            const rows = data.length;
            const cols = data[0].length;
            let numericCols = 0;
            let textCols = 0;
            let totalValues = 0;
            let missingValues = 0;
            let numericValues = [];

            // Analyze each column
            for (let c = 0; c < cols; c++) {
                let isNumeric = true;
                let hasValues = false;
                
                for (let r = 0; r < rows; r++) {
                    const value = data[r][c];
                    if (value !== null && value !== undefined && value !== '') {
                        hasValues = true;
                        totalValues++;
                        
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            numericValues.push(numValue);
                        } else {
                            isNumeric = false;
                        }
                    } else {
                        missingValues++;
                    }
                }
                
                if (hasValues) {
                    if (isNumeric && numericValues.length > 0) {
                        numericCols++;
                    } else {
                        textCols++;
                    }
                }
            }

            // Calculate statistics for numeric columns
            let numericSummary = '';
            if (numericValues.length > 0) {
                const sorted = numericValues.sort((a, b) => a - b);
                const sum = numericValues.reduce((a, b) => a + b, 0);
                const mean = sum / numericValues.length;
                const median = sorted[Math.floor(sorted.length / 2)];
                const min = sorted[0];
                const max = sorted[sorted.length - 1];
                
                numericSummary = `
                    <p>数值总数: ${numericValues.length}</p>
                    <p>平均值: ${mean.toFixed(2)}</p>
                    <p>中位数: ${median.toFixed(2)}</p>
                    <p>最小值: ${min.toFixed(2)}</p>
                    <p>最大值: ${max.toFixed(2)}</p>
                `;
            }

            // Find duplicate rows
            const rowStrings = data.map(row => JSON.stringify(row));
            const uniqueRows = new Set(rowStrings);
            const duplicateRows = rows - uniqueRows.size;

            return {
                rows,
                cols,
                numericCols,
                textCols,
                missingRatio: totalValues > 0 ? ((missingValues / (rows * cols)) * 100).toFixed(1) : 0,
                duplicateRows,
                numericSummary
            };
        }

        // Call API for data analysis (similar to chart.html)
        async function callAPIForAnalysis(analysisPrompt) {
            try {
                console.log('开始调用API进行数据分析...');
                
                // 获取当前选择的模型
                const selectedModel = document.querySelector('input[name="model-selection"]:checked');
                const modelType = selectedModel ? selectedModel.value : 'deepseek';
                console.log('使用模型:', modelType);
                
                // 构建系统消息，专注于数据分析
                const systemMessage = `你是一个专业的数据分析师，具有丰富的业务分析经验。请严格按照以下要求进行分析：

**重要提醒：必须严格基于提供的实际数据进行分析，禁止使用任何随机生成的数据、假设的数据或示例数据。所有分析结论必须完全基于提供的数据集。**

分析要求：
1. 数据概览 - 简要描述数据集的业务含义（仅基于实际数据）
2. 核心发现 - 指出数据中的主要模式、趋势、异常和业务洞察（仅基于实际数据）
3. 实用建议 - 基于分析结果提供2-3条具体可行的业务建议（仅基于实际数据）

输出格式要求：
- 使用Markdown格式，结构清晰
- 内容简明扼要，突出重点
- 避免冗长的技术细节
- 专注于有价值的业务洞察
- 不要生成任何图表代码或HTML代码
- 提供可直接用于决策的建议
- 如果数据不足或质量不佳，请如实说明，不要编造分析结果

请严格按照用户提供的分析任务要求执行，不要添加额外的内容或格式。`;
                
                const fullPrompt = `${systemMessage}\n\n分析任务：${analysisPrompt}`;
                
                console.log('发送数据分析请求到API...');
                
                // 使用统一的API端点
                const API_BASE_URL = 'https://multi-model-worker.study-llm.me';
                
                // 构建请求体
                const requestBody = {
                    model: modelType, // 使用选择的模型
                    messages: [
                        {
                            role: "user",
                            content: fullPrompt
                        }
                    ],
                    stream: false
                };
                
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} - ${errorText}`);
                }

                // 处理响应
                const result = await response.json();
                
                // 提取分析内容
                let content;
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    content = result.choices[0].message.content;
                } else if (result.output) {
                    content = result.output;
                } else if (result.response) {
                    content = result.response;
                } else {
                    content = JSON.stringify(result, null, 2);
                }
                
                if (!content || content.length === 0) {
                    throw new Error('API返回了空内容');
                }
                
                return content;
                
            } catch (error) {
                console.error('API调用错误:', error);
                let errorMessage = '无法连接到数据分析服务';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '网络连接失败，请检查网络连接后重试。';
                } else {
                    errorMessage += ': ' + error.message;
                }
                throw new Error(errorMessage);
            }
        }

        // Generate chart code
        async function generateChartCode() {
            // Get data from Luckysheet instead of workbook
            const luckysheetData = getLuckysheetData();
            
            if (!luckysheetData || !luckysheetData.data || luckysheetData.data.length === 0) {
                showStatus('请先上传数据文件或在Luckysheet中输入数据！', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateChartBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';

            try {
                const cleanedData = luckysheetData.data;
                
                if (cleanedData.length === 0) {
                    throw new Error('数据为空或所有数据都是空值，无法生成图表');
                }
                
                const requirement = document.getElementById('chartRequirement').value.trim();
                
                let code;
                if (requirement) {
                    // Use API to generate chart code based on requirement only
                    code = await generateChartCodeFromRequirement(cleanedData, requirement);
                } else {
                    // Default to bar chart if no requirement specified
                    code = await generateChartCodeFromData(cleanedData, 'bar');
                }
                
                generatedChartCode = code;
                // Remove markdown code block formatting if present
                const cleanCode = code.replace(/^```html\n/, '').replace(/\n```$/, '');
                document.getElementById('codeOutput').value = cleanCode;
                document.getElementById('chartResult').classList.add('show');
                document.getElementById('chartGenerationSection').classList.add('show');
                document.getElementById('executeScriptBtn').disabled = false;
                
                showStatus('图表代码生成完成！正在自动执行...', 'success');
                
                // Auto-execute the chart script after a short delay
                setTimeout(() => {
                    executeChartScript();
                }, 500);
                
            } catch (error) {
                console.error('图表代码生成错误:', error);
                showStatus('图表代码生成失败：' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-code"></i> 生成图表代码';
            }
        }

        // Generate chart code from data
        async function generateChartCodeFromData(data, chartType) {
            try {
                if (!data || data.length === 0) {
                    throw new Error('数据为空');
                }

                // Clean data first to remove empty rows and columns
                const cleanedData = cleanData(data);
                if (cleanedData.length === 0) {
                    throw new Error('清理后的数据为空');
                }

            // Get selected model
            const selectedModel = document.querySelector('input[name="modelType"]:checked');
            const modelType = selectedModel ? selectedModel.value : 'deepseek';
            
            // Prepare data summary for the prompt from cleaned data
            const headers = cleanedData[0];
            
            // Get all cleaned data (excluding header)
            const dataRows = cleanedData.slice(1);
            
            // Transform data to object format for better API understanding
            const structuredData = dataRows.map(row => {
                const rowObj = {};
                headers.forEach((header, index) => {
                    const value = row[index];
                    rowObj[header] = value === null || value === undefined || value === '' ? '空值' : String(value);
                });
                return rowObj;
            });
            
            // Build system message and prompt
            const systemMessage = `你是一个HTML图表生成专家。请根据提供的数据结构和图表类型要求生成完整的HTML图表代码，包含HTML文档结构、ECharts库引用、图表容器和初始化代码。重要要求：
1. 图表容器必须使用合适的尺寸，设置width: 100%, height: 500px, minHeight: 400px, maxHeight: 600px
2. 图表容器样式应包含position: relative, margin: 1rem 0, padding: 10px, boxSizing: border-box, clear: both, display: block, flexDirection: column
3. 确保图表能够正常显示，不要被任何容器限制，保持正常的长宽比
4. 图表初始化代码中设置responsive: true以支持响应式布局
5. 如果用户需要生成多个图表，请确保每个图表独立成行显示，一行只显示一个图表
6. 多个图表时，请为每个图表创建独立的容器，确保每个图表都有足够的显示空间，避免彼此覆盖或显示不全
7. 添加响应式设计，适配不同设备：移动端(300-500px)、平板端(350-550px)、桌面端(400-600px)
8. 为图表容器添加圆角边框和阴影效果：borderRadius: 8px, boxShadow: 0 2px 8px rgba(0,0,0,0.1)
9. 只返回完整的HTML代码，不包含任何解释文字或注释。请根据数据特点自动选择最适合的图表类型。`;
            
            const userPrompt = `图表类型要求：${chartType}

完整数据集信息：
- 列名：${JSON.stringify(headers)}
- 数据行数：${dataRows.length}

**完整数据集：**
${JSON.stringify(structuredData, null, 2)}

请基于以上完整数据集和图表类型要求生成合适的图表代码。根据数据特点自动选择最适合的图表配置和样式。确保使用所有提供的数据进行分析。`;
            
            const fullPrompt = `${systemMessage}\n\n${userPrompt}`;
            
            // API configuration
            const API_BASE_URL = 'https://multi-model-worker.study-llm.me';
            const API_ENDPOINT = `${API_BASE_URL}/chat`;
            
            // Build request body
            const requestBody = {
                model: modelType,
                messages: [
                    {
                        role: "user",
                        content: fullPrompt
                    }
                ],
                stream: false
            };
            
            console.log('发送图表生成请求到API...');
            console.log('使用模型:', modelType);
            
            // Call API
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API调用失败: ${response.status} - ${errorText}`);
            }
            
            // Process response
            const result = await response.json();
            
            // Extract content from different API response formats
            let content;
            if (result.choices && result.choices[0] && result.choices[0].message) {
                content = result.choices[0].message.content;
            } else if (result.output) {
                content = result.output;
            } else if (result.response) {
                content = result.response;
            } else {
                content = JSON.stringify(result, null, 2);
            }
            
            if (!content || content.length === 0) {
                throw new Error('API返回了空内容');
            }
            
            console.log('API返回内容长度:', content.length);
            console.log('内容预览:', content.substring(0, 200));
            
            return content;
            
        } catch (error) {
            console.error('API调用错误:', error);
            let errorMessage = '无法连接到图表生成服务';
            if (error.message.includes('Failed to fetch')) {
                errorMessage = '网络连接失败，请检查网络连接后重试。';
            } else {
                errorMessage += ': ' + error.message;
            }
            throw new Error(errorMessage);
        }
        }

        // Generate chart code from requirement using API
        async function generateChartCodeFromRequirement(data, requirement) {
            try {
                // Get selected model
                const selectedModel = document.querySelector('input[name="modelType"]:checked');
                const modelType = selectedModel ? selectedModel.value : 'deepseek';
                
                // Clean data first to remove empty rows and columns
                const cleanedData = cleanData(data);
                if (cleanedData.length === 0) {
                    throw new Error('清理后的数据为空，无法进行图表生成');
                }
                
                // Prepare data summary for the prompt from cleaned data
                const headers = cleanedData[0];
                
                // Get all cleaned data (excluding header)
                const dataRows = cleanedData.slice(1);
                
                // Transform data to object format for better API understanding
                const structuredData = dataRows.map(row => {
                    const rowObj = {};
                    headers.forEach((header, index) => {
                        const value = row[index];
                        rowObj[header] = value === null || value === undefined || value === '' ? '空值' : String(value);
                    });
                    return rowObj;
                });
                
                // Build system message and prompt
                const systemMessage = `你是一个HTML图表生成专家。请根据用户的需求和提供的数据结构生成完整的HTML图表代码，包含HTML文档结构、ECharts库引用、图表容器和初始化代码。重要要求：
1. 图表容器必须使用合适的尺寸，设置width: 100%, height: 500px, minHeight: 400px, maxHeight: 600px
2. 图表容器样式应包含position: relative, margin: 1rem 0, padding: 10px, boxSizing: border-box, clear: both, display: block, flexDirection: column
3. 确保图表能够正常显示，不要被任何容器限制，保持正常的长宽比
4. 图表初始化代码中设置responsive: true以支持响应式布局
5. 如果用户需要生成多个图表，请确保每个图表独立成行显示，一行只显示一个图表
6. 多个图表时，请为每个图表创建独立的容器，确保每个图表都有足够的显示空间，避免彼此覆盖或显示不全
7. 添加响应式设计，适配不同设备：移动端(300-500px)、平板端(350-550px)、桌面端(400-600px)
8. 为图表容器添加圆角边框和阴影效果：borderRadius: 8px, boxShadow: 0 2px 8px rgba(0,0,0,0.1)
9. 只返回完整的HTML代码，不包含任何解释文字或注释。请根据用户需求自动选择合适的图表类型。`;
                
                const userPrompt = `用户需求：${requirement}

完整数据集信息：
- 列名：${JSON.stringify(headers)}
- 数据行数：${dataRows.length}

**完整数据集：**
${JSON.stringify(structuredData, null, 2)}

请基于以上完整数据集生成合适的图表代码，根据用户需求自动选择最适合的图表类型。确保使用所有提供的数据进行分析。`;
                
                const fullPrompt = `${systemMessage}\n\n${userPrompt}`;
                
                // API configuration
                const API_BASE_URL = 'https://multi-model-worker.study-llm.me';
                const API_ENDPOINT = `${API_BASE_URL}/chat`;
                
                // Build request body
                const requestBody = {
                    model: modelType,
                    messages: [
                        {
                            role: "user",
                            content: fullPrompt
                        }
                    ],
                    stream: false
                };
                
                console.log('发送图表生成请求到API...');
                console.log('使用模型:', modelType);
                
                // Call API
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} - ${errorText}`);
                }
                
                // Process response
                const result = await response.json();
                
                // Extract content from different API response formats
                let content;
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    content = result.choices[0].message.content;
                } else if (result.output) {
                    content = result.output;
                } else if (result.response) {
                    content = result.response;
                } else {
                    content = JSON.stringify(result, null, 2);
                }
                
                if (!content || content.length === 0) {
                    throw new Error('API返回了空内容');
                }
                
                console.log('API返回内容长度:', content.length);
                console.log('内容预览:', content.substring(0, 200));
                
                return content;
                
            } catch (error) {
                console.error('API调用错误:', error);
                let errorMessage = '无法连接到图表生成服务';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = '网络连接失败，请检查网络连接后重试。';
                } else {
                    errorMessage += ': ' + error.message;
                }
                throw new Error(errorMessage);
            }
        }

        // Execute chart script
        function executeChartScript() {
            const codeOutput = document.getElementById('codeOutput');
            const currentCode = codeOutput.value.trim();
            
            if (!currentCode) {
                showStatus('请先生成图表代码！', 'error');
                return;
            }

            const executeBtn = document.getElementById('executeScriptBtn');
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 执行中...';

            try {
                // Create iframe to display chart
                const chartContent = document.getElementById('chartContent');
                chartContent.innerHTML = '';
                
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                
                chartContent.appendChild(iframe);
                
                // Write the current code from textarea to iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(currentCode);
                iframeDoc.close();
                
                document.getElementById('chartResult').classList.add('show');
                showStatus('图表执行成功！', 'success');
                
            } catch (error) {
                console.error('图表执行错误:', error);
                showStatus('图表执行失败：' + error.message, 'error');
            } finally {
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i class="fas fa-play"></i> 执行脚本';
            }
        }

        // Toggle code editor expansion
        function toggleCodeEditor() {
            const codeOutput = document.getElementById('codeOutput');
            const expandBtn = document.getElementById('expandCodeBtn');
            const icon = expandBtn.querySelector('i');
            
            codeOutput.classList.toggle('expanded');
            
            if (codeOutput.classList.contains('expanded')) {
                icon.className = 'fas fa-compress';
                expandBtn.title = '收起编辑器';
            } else {
                icon.className = 'fas fa-expand';
                expandBtn.title = '展开编辑器';
            }
        }

        // View chart in new window
        function viewChartInNewWindow() {
            const codeOutput = document.getElementById('codeOutput');
            const currentCode = codeOutput.value.trim();
            
            if (!currentCode) {
                showStatus('请先生成图表代码！', 'error');
                return;
            }

            try {
                // Open new window
                const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                if (!newWindow) {
                    showStatus('弹窗被浏览器阻止，请允许弹窗后重试', 'error');
                    return;
                }
                
                // Write the chart code to new window
                newWindow.document.write(currentCode);
                newWindow.document.close();
                
                showStatus('图表已在新窗口中打开', 'success');
                
            } catch (error) {
                console.error('新窗口打开错误:', error);
                showStatus('无法打开新窗口：' + error.message, 'error');
            }
        }
    </script>
</body>
</html>